<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°”ì½”ë“œ ìŠ¤ìº”</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .top-menu {
            background-color: #fff;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .menu-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }
        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 3px;
            color: #333;
            text-decoration: none;
        }
        .menu-item:hover {
            background-color: #f0f0f0;
        }
        .menu-item.active {
            background-color: #e0e0e0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .input-area {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        .quantity-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 100px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }
        .quantity-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .box-selection-area {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            background-color: #f5f5f5;
        }
        .box-selection-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .box-selection-dropdowns {
            display: flex;
            gap: 15px;
        }
        .dropdown-container {
            flex: 1;
        }
        .dropdown-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .box-dropdown {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 18px;
        }
        .input-field {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            flex: 1;
        }
        .scan-btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .scan-btn:hover {
            background-color: #45a049;
        }
        .result-box {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: #f9f9f9;
            margin-top: 10px;
            min-height: 50px;
            text-align: center;
        }
        .barcode-display {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .product-name {
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .scan-count {
            font-size: 5em;
            font-weight: bold;
        }
        .count-complete {
            color: #4CAF50; /* ì´ˆë¡ìƒ‰ */
        }
        .count-partial {
            color: #FFC107; /* ë…¸ë€ìƒ‰ */
        }
        .error-message {
            font-size: 2.5em;
            color: red;
            margin-top: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        .scan-complete {
            background-color: #c8e6c9; /* ì´ˆë¡ìƒ‰ - í™•ì •ìˆ˜ëŸ‰ = ìŠ¤ìº”ìˆ˜ëŸ‰ */
        }
        .scan-partial {
            background-color: #fff59d; /* ë…¸ë€ìƒ‰ - í™•ì •ìˆ˜ëŸ‰ > ìŠ¤ìº”ìˆ˜ëŸ‰ > 0 */
        }
        .scan-none {
            /* ìŠ¤ìº”ìˆ˜ëŸ‰ = 0ì¸ ê²½ìš° ë°°ê²½ìƒ‰ ì—†ìŒ */
        }
        .current-box-info {
            background-color: #e3f2fd;
            border-radius: 4px;
            padding: 10px 15px;
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        .box-info-container {
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 10px 0;
        }
        .box-info-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .box-card {
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            margin: 5px;
            font-size: 18px;
            white-space: nowrap;
            min-width: 150px;
            justify-content: center;
            position: relative;
        }
        .box-card:hover {
            background-color: #f0f0f0;
        }
        .delete-btn {
            padding: 5px 10px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
            position: absolute;
            right: 5px;
            top: 5px;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 5px;
            position: relative;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .modal-body {
            margin: 15px 0;
        }
        
        .modal-body select {
            margin: 8px 0 15px 0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .modal-btn-cancel {
            background-color: #e0e0e0;
        }
        
        .modal-btn-submit {
            background-color: #4CAF50;
            color: white;
        }
        
        /* ë°•ìŠ¤ ìƒí’ˆ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .box-products-modal {
            display: none;
            position: fixed;
            z-index: 1001; /* ê¸°ì¡´ ëª¨ë‹¬ë³´ë‹¤ ë†’ê²Œ ì„¤ì • */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .box-products-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 5px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        .box-products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .box-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .box-products-title {
            font-size: 20px;
            font-weight: bold;
        }
        .box-size-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-width: 100px;
        }
        .box-actions {
            display: flex;
            gap: 10px;
        }
        .box-edit-btn, .box-delete-btn, .box-close-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }
        .box-edit-btn {
            background-color: #4CAF50;
        }
        .box-edit-btn:hover {
            background-color: #45a049;
        }
        .box-delete-btn {
            background-color: #ff4444;
        }
        .box-delete-btn:hover {
            background-color: #cc0000;
        }
        .box-close-btn {
            background-color: #777;
        }
        .box-close-btn:hover {
            background-color: #555;
        }
        .order-info {
            background-color: #e8f4ff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            display: none;
        }
        .product-detail {
            margin-top: 10px;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            font-size: 20px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #856404;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    <div class="container">
        <h1>ë°”ì½”ë“œ ìŠ¤ìº”</h1>
        <div class="content">
            <!-- ë°”ì½”ë“œ ìŠ¤ìº” ì˜ì—­ -->
            <div class="section">
                <div class="section-title">ë°”ì½”ë“œ ìŠ¤ìº” ì˜ì—­</div>
                
                <!-- ë°•ìŠ¤ ì„ íƒ ì˜ì—­ -->
                <div class="box-selection-area">
                    <div class="box-selection-dropdowns">
                        <div class="dropdown-container">
                            <select id="boxNumber" class="box-dropdown">
                                <option value="">ë°•ìŠ¤ ë²ˆí˜¸ ì„ íƒ</option>
                                <option value="BOX1">BOX1</option>
                                <option value="BOX2">BOX2</option>
                                <option value="BOX3">BOX3</option>
                                <option value="BOX4">BOX4</option>
                                <option value="BOX5">BOX5</option>
                                <option value="BOX6">BOX6</option>
                                <option value="BOX7">BOX7</option>
                                <option value="BOX8">BOX8</option>
                                <option value="BOX9">BOX9</option>
                            </select>
                        </div>
                        <div class="dropdown-container">
                            <select id="boxSize" class="box-dropdown">
                                <option value="">ë°•ìŠ¤ í¬ê¸° ì„ íƒ</option>
                                <option value="ê·¹ì†Œ">ê·¹ì†Œ</option>
                                <option value="ì†Œ">ì†Œ</option>
                                <option value="ì¤‘">ì¤‘</option>
                                <option value="ëŒ€1">ëŒ€1</option>
                                <option value="ëŒ€2">ëŒ€2</option>
                            </select>
                        </div>
                    </div>
                    <div id="currentBoxInfo" class="current-box-info" style="display: none;">
                        ì‘ì—… ì¤‘ì¸ ë°•ìŠ¤: <span id="currentBoxText">ì„ íƒ ì•ˆë¨</span>
                    </div>
                </div>

                <div class="input-area">
                    <input type="text" id="barcode" class="input-field" placeholder="ë°”ì½”ë“œ ì…ë ¥" disabled>
                    <div style="display: flex; flex-direction: column;">
                        <label for="quantity" class="quantity-label">ìˆ˜ëŸ‰</label>
                        <input type="number" id="quantity" class="quantity-input" placeholder="ìˆ˜ëŸ‰" value="1" min="1" disabled>
                    </div>
                    <button class="scan-btn" onclick="scanBarcode()" disabled>ìŠ¤ìº”</button>
                </div>
                <div class="result-box" id="barcodeResult">ë°”ì½”ë“œ ìŠ¤ìº” ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>

            <!-- ë°œì£¼ì„œ ì˜ì—­ -->
            <div class="section">
                <div class="section-title">ë°œì£¼ì„œ ì˜ì—­</div>
                <div class="input-area">
                    <input type="text" id="orderNumber" class="input-field" placeholder="ë°œì£¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button class="scan-btn" onclick="loadOrder()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
                
                <!-- ë°œì£¼ì„œ ì •ë³´ í‘œì‹œ ì˜ì—­ ì¶”ê°€ -->
                <div id="orderInfo" class="order-info"></div>
                
                <!-- ë°œì£¼ì„œì˜ ë°•ìŠ¤ì •ë³´ë¥¼ í‘œì‹œí•  ì˜ì—­ ì¶”ê°€ -->
                <div id="boxInfoContainer" class="box-info-container" style="display: none;">
                    <div class="section-title">ë°•ìŠ¤ ì •ë³´</div>
                    <div id="boxInfoContent" class="box-info-content" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>ìƒí’ˆë°”ì½”ë“œ</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>í™•ì •ìˆ˜ëŸ‰</th>
                            <th>ìŠ¤ìº”ìˆ˜ëŸ‰</th>
                            <th>ìœ„ì¹˜</th>
                        </tr>
                    </thead>
                    <tbody id="productList">
                        <!-- ìƒí’ˆ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ë°•ìŠ¤ ìƒí’ˆ ëª¨ë‹¬ ì¶”ê°€ -->
    <div id="boxProductsModal" class="box-products-modal">
        <div class="box-products-content">
            <div class="box-products-header">
                <div class="box-title-container">
                    <span id="boxProductsTitle" class="box-products-title">BOX1-ê·¹ì†Œ</span>
                    <select id="boxSizeSelect" class="box-size-select">
                        <option value="ê·¹ì†Œ">ê·¹ì†Œ</option>
                        <option value="ì†Œ">ì†Œ</option>
                        <option value="ì¤‘">ì¤‘</option>
                        <option value="ëŒ€1">ëŒ€1</option>
                        <option value="ëŒ€2">ëŒ€2</option>
                    </select>
                </div>
                <div class="box-actions">
                    <button class="box-edit-btn" id="boxEditBtn">ë°•ìŠ¤ ì •ë³´ ìˆ˜ì •</button>
                    <button class="box-delete-btn" id="boxDeleteBtn">ë°•ìŠ¤ ì‚­ì œ</button>
                    <button class="box-close-btn" onclick="closeBoxProductsModal()">ë‹«ê¸°</button>
                </div>
            </div>
            <div id="boxProductsBody">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ìƒí’ˆë°”ì½”ë“œ</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>í™•ì •ìˆ˜ëŸ‰</th>
                            <th>ìŠ¤ìº”ìˆ˜ëŸ‰</th>
                        </tr>
                    </thead>
                    <tbody id="boxProductsList">
                        <!-- ë°•ìŠ¤ë³„ ìƒí’ˆ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì¶”ê°€ -->
    <div id="editBoxModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ë°•ìŠ¤ ì •ë³´ ìˆ˜ì •</div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <div style="margin-bottom: 5px;">í˜„ì¬ ë°•ìŠ¤ ì •ë³´: <span id="currentBoxInfoText"></span></div>
                </div>
                <div>
                    <label>ë°•ìŠ¤ ë²ˆí˜¸:</label>
                    <select id="editBoxNumber" class="box-dropdown" style="width: 100%;">
                        <option value="">ë°•ìŠ¤ ë²ˆí˜¸ ì„ íƒ</option>
                        <option value="BOX1">BOX1</option>
                        <option value="BOX2">BOX2</option>
                        <option value="BOX3">BOX3</option>
                        <option value="BOX4">BOX4</option>
                        <option value="BOX5">BOX5</option>
                        <option value="BOX6">BOX6</option>
                        <option value="BOX7">BOX7</option>
                        <option value="BOX8">BOX8</option>
                        <option value="BOX9">BOX9</option>
                    </select>
                </div>
                <div>
                    <label>ë°•ìŠ¤ í¬ê¸°:</label>
                    <select id="editBoxSize" class="box-dropdown" style="width: 100%;">
                        <option value="">ë°•ìŠ¤ í¬ê¸° ì„ íƒ</option>
                        <option value="ê·¹ì†Œ">ê·¹ì†Œ</option>
                        <option value="ì†Œ">ì†Œ</option>
                        <option value="ì¤‘">ì¤‘</option>
                        <option value="ëŒ€1">ëŒ€1</option>
                        <option value="ëŒ€2">ëŒ€2</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeEditBoxModal()">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-submit" onclick="submitBoxEdit()">ìˆ˜ì •</button>
            </div>
        </div>
    </div>

    <!-- ìŒí–¥ íš¨ê³¼ ì¶”ê°€ -->
    <!-- ì˜¤ë””ì˜¤ íŒŒì¼ ì—†ì´ ë¸Œë¼ìš°ì € APIë¡œ íš¨ê³¼ìŒ êµ¬í˜„ -->
    <script>
        // ê²½ê³ ìŒ ìƒì„± í•¨ìˆ˜
        function playWarningSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // ë” ê°•í•œ ê²½ê³ ìŒì„ ìœ„í•œ ì„¤ì •
            oscillator.type = 'square';
            oscillator.frequency.value = 800; // ë†’ì€ ì£¼íŒŒìˆ˜ë¡œ ë³€ê²½
            
            // ê²½ê³ ìŒ íŒ¨í„´ ìƒì„± (ë°˜ë³µìŒ)
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // ë” í° ì†Œë¦¬ë¡œ ì„¤ì •
            gainNode.gain.value = 0.7;
            
            // ì‹œì‘
            oscillator.start();
            
            // 0.15ì´ˆ ê°„ê²©ìœ¼ë¡œ ì†Œë¦¬ í¬ê¸° ë³€ê²½ (ê¹œë¹¡ì´ëŠ” íš¨ê³¼)
            setTimeout(() => { gainNode.gain.value = 0; }, 150);
            setTimeout(() => { gainNode.gain.value = 0.7; }, 300);
            setTimeout(() => { gainNode.gain.value = 0; }, 450);
            setTimeout(() => { gainNode.gain.value = 0.7; }, 600);
            
            // 0.75ì´ˆ í›„ ì†Œë¦¬ ì¤‘ì§€
            setTimeout(() => {
                oscillator.stop();
            }, 750);
        }
        
        // ì„±ê³µìŒ ìƒì„± í•¨ìˆ˜
        function playSuccessSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            
            // ìƒìŠ¹í•˜ëŠ” ìŒê³„ë¡œ ì„¤ì •
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
            oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime + 0.3); // C6 (í•œ ì˜¥íƒ€ë¸Œ ìœ„)
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            gainNode.gain.value = 0.5;
            oscillator.start();
            
            // 0.4ì´ˆ í›„ ì†Œë¦¬ ì¤‘ì§€
            setTimeout(() => {
                oscillator.stop();
            }, 400);
        }
    </script>

    <script>
        // í—¤ë” ë¡œë“œ
        fetch('/header')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
            });

        let currentOrder = null;
        let lastScannedBarcode = null;
        let boxInfoMap = new Map(); // ë°•ìŠ¤ ì •ë³´ë¥¼ ì €ì¥í•  ë§µ

        async function loadOrder() {
            const orderNumber = document.getElementById('orderNumber').value;
            if (!orderNumber) {
                alert('ë°œì£¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`/api/orders/${orderNumber}`);
                if (!response.ok) {
                    throw new Error('ë°œì£¼ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                currentOrder = await response.json();
                
                // ë°œì£¼ì„œ ì •ë³´ í‘œì‹œ (ë°œì£¼ë²ˆí˜¸, ë¬¼ë¥˜ì„¼í„°, ì…ê³ ì˜ˆì •ì¼)
                const orderInfoEl = document.getElementById('orderInfo');
                orderInfoEl.innerHTML = `${currentOrder.ë°œì£¼ë²ˆí˜¸} (${currentOrder.ë¬¼ë¥˜ì„¼í„°}) ì…ê³ ì˜ˆì •ì¼ : ${currentOrder.ì…ê³ ì˜ˆì •ì¼}`;
                orderInfoEl.style.display = 'block';
                
                // ë°”ì½”ë“œ ì…ë ¥ í•„ë“œëŠ” ë¹„í™œì„±í™” ìƒíƒœë¡œ ìœ ì§€ (ë°•ìŠ¤ ì„ íƒ ì‹œ í™œì„±í™”)
                document.getElementById('barcode').disabled = true;
                document.querySelector('.scan-btn[onclick="scanBarcode()"]').disabled = true;
                
                // ë°•ìŠ¤ ì„ íƒ ë“œë¡­ë‹¤ìš´ í™œì„±í™”
                document.getElementById('boxNumber').disabled = false;
                document.getElementById('boxSize').disabled = false;
                
                // ë°•ìŠ¤ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
                document.getElementById('boxNumber').value = '';
                document.getElementById('boxSize').value = '';
                
                // ê²°ê³¼ í…Œì´ë¸” ì´ˆê¸°í™”
                const tbody = document.getElementById('productList');
                tbody.innerHTML = '';
                
                // ìƒí’ˆ ì •ë³´ í‘œì‹œ (ë°•ìŠ¤ì •ë³´ê°€ ì—†ëŠ” ì›ë³¸ ìƒí’ˆë§Œ í‘œì‹œ)
                currentOrder.ìƒí’ˆì •ë³´
                    .filter(product => !product.ë°•ìŠ¤ì •ë³´)
                    .forEach(product => {
                        const row = document.createElement('tr');
                        // ìŠ¤ìº” ìƒíƒœì— ë”°ë¥¸ í–‰ ìƒ‰ìƒ ì„¤ì •
                        if (product.ìŠ¤ìº”ìˆ˜ëŸ‰ >= product.í™•ì •ìˆ˜ëŸ‰) {
                            row.className = 'scan-complete';
                        } else if (product.ìŠ¤ìº”ìˆ˜ëŸ‰ > 0) {
                            row.className = 'scan-partial';
                        } else {
                            row.className = 'scan-none';
                        }
                        
                        row.innerHTML = `
                            <td>${product.ìƒí’ˆë°”ì½”ë“œ}</td>
                            <td>${product.ìƒí’ˆì´ë¦„}</td>
                            <td>${product.í™•ì •ìˆ˜ëŸ‰}</td>
                            <td>${product.ìŠ¤ìº”ìˆ˜ëŸ‰ || 0}</td>
                            <td>${product.ìœ„ì¹˜ || '-'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                
                // ë°•ìŠ¤ ì •ë³´ ë§µ ì´ˆê¸°í™” ë° ì±„ìš°ê¸°
                boxInfoMap.clear();
                currentOrder.ìƒí’ˆì •ë³´
                    .filter(product => product.ë°•ìŠ¤ì •ë³´)
                    .forEach(product => {
                        const boxInfo = product.ë°•ìŠ¤ì •ë³´;
                        if (!boxInfoMap.has(boxInfo)) {
                            const [boxNumber, boxSize] = boxInfo.split('-');
                            boxInfoMap.set(boxInfo, {
                                boxNumber,
                                boxSize,
                                products: []
                            });
                        }
                    });
                
                // ë°•ìŠ¤ ì •ë³´ UI ì—…ë°ì´íŠ¸
                updateBoxInfoUI();
                
                // ë°•ìŠ¤ ì„ íƒì— í¬ì»¤ìŠ¤
                document.getElementById('boxNumber').focus();
            } catch (error) {
                alert(error.message);
            }
        }

        // ë°•ìŠ¤ ì •ë³´ UI ì—…ë°ì´íŠ¸
        function updateBoxInfoUI() {
            const boxInfoContent = document.getElementById('boxInfoContent');
            boxInfoContent.innerHTML = '';
            
            if (boxInfoMap.size > 0) {
                document.getElementById('boxInfoContainer').style.display = 'block';
                
                boxInfoMap.forEach((info, boxInfo) => {
                    const boxCard = document.createElement('div');
                    boxCard.className = 'box-card';
                    boxCard.innerHTML = `ğŸ“¦ ${info.boxNumber} - ${info.boxSize}`;
                    boxCard.onclick = () => openBoxProductsModal(info.boxNumber, info.boxSize);
                    boxInfoContent.appendChild(boxCard);
                });
            } else {
                document.getElementById('boxInfoContainer').style.display = 'none';
            }
        }

        // ë°•ìŠ¤ ìƒí’ˆ ëª¨ë‹¬ ì—´ê¸°
        function openBoxProductsModal(boxNumber, boxSize) {
            if (!currentOrder) return;
            
            const boxInfo = `${boxNumber}-${boxSize}`;
            const modal = document.getElementById('boxProductsModal');
            const boxProductsList = document.getElementById('boxProductsList');
            const boxProductsTitle = document.getElementById('boxProductsTitle');
            const boxSizeSelect = document.getElementById('boxSizeSelect');
            
            // ëª¨ë‹¬ ì œëª© ì„¤ì •
            boxProductsTitle.textContent = `${boxNumber}-${boxSize}`;
            
            // ë°•ìŠ¤ í¬ê¸° ë“œë¡­ë‹¤ìš´ í˜„ì¬ ê°’ ì„¤ì •
            boxSizeSelect.value = boxSize;
            
            // í…Œì´ë¸” ì´ˆê¸°í™”
            boxProductsList.innerHTML = '';
            
            // ë°•ìŠ¤ì— í¬í•¨ëœ ìƒí’ˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const boxProducts = currentOrder.ìƒí’ˆì •ë³´.filter(product => product.ë°•ìŠ¤ì •ë³´ === boxInfo);
            
            if (boxProducts.length > 0) {
                boxProducts.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.ìƒí’ˆë°”ì½”ë“œ}</td>
                        <td>${product.ìƒí’ˆì´ë¦„}</td>
                        <td>${product.í™•ì •ìˆ˜ëŸ‰}</td>
                        <td>${product.ìŠ¤ìº”ìˆ˜ëŸ‰ || 0}</td>
                    `;
                    boxProductsList.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center;">ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
                boxProductsList.appendChild(row);
            }
            
            // ë°•ìŠ¤ ì •ë³´ ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
            document.getElementById('boxEditBtn').onclick = () => {
                updateBoxSize(boxNumber, boxSize);
            };
            
            // ë°•ìŠ¤ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
            document.getElementById('boxDeleteBtn').onclick = () => {
                confirmDeleteBox(boxNumber, boxSize);
            };
            
            // ëª¨ë‹¬ í‘œì‹œ
            modal.style.display = 'block';
        }
        
        // ë°•ìŠ¤ í¬ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateBoxSize(boxNumber, oldBoxSize) {
            if (!currentOrder) return;
            
            const newBoxSize = document.getElementById('boxSizeSelect').value;
            if (newBoxSize === oldBoxSize) {
                alert('ë°•ìŠ¤ í¬ê¸°ê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (confirm(`ë°•ìŠ¤ í¬ê¸°ë¥¼ ${oldBoxSize}ì—ì„œ ${newBoxSize}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                fetch('/api/scan/updateBox', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderNumber: currentOrder.ë°œì£¼ë²ˆí˜¸,
                        oldBoxNumber: boxNumber,
                        oldBoxSize: oldBoxSize,
                        newBoxNumber: boxNumber,
                        newBoxSize: newBoxSize
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ë°•ìŠ¤ ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);
                    closeBoxProductsModal();
                    loadOrder();  // ë³€ê²½ ì‚¬í•­ ë°˜ì˜ì„ ìœ„í•´ ë°œì£¼ì„œ ë‹¤ì‹œ ë¡œë“œ
                })
                .catch(error => {
                    alert(error.message);
                });
            }
        }
        
        // ë°•ìŠ¤ ìƒí’ˆ ëª¨ë‹¬ ë‹«ê¸°
        function closeBoxProductsModal() {
            document.getElementById('boxProductsModal').style.display = 'none';
        }

        // ë°•ìŠ¤ ìƒí’ˆ ì‚­ì œ í™•ì¸
        function deleteBoxProduct(barcode, boxInfo) {
            if (!currentOrder) return;
            
            if (confirm(`${boxInfo} ë°•ìŠ¤ì˜ ${barcode} ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // API í˜¸ì¶œí•˜ì—¬ ìŠ¤ìº”ìˆ˜ëŸ‰ì„ 0ìœ¼ë¡œ ì„¤ì • (ì„œë²„ì—ì„œ ìë™ ì‚­ì œë¨)
                fetch('/api/scan/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderNumber: currentOrder.ë°œì£¼ë²ˆí˜¸,
                        barcode: barcode,
                        boxInfo: boxInfo,
                        scanCount: 0
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);
                    closeBoxProductsModal(); // ëª¨ë‹¬ ë‹«ê¸°
                    loadOrder();  // ë³€ê²½ ì‚¬í•­ ë°˜ì˜ì„ ìœ„í•´ ë°œì£¼ì„œ ë‹¤ì‹œ ë¡œë“œ
                })
                .catch(error => {
                    alert(error.message);
                });
            }
        }

        // ë°•ìŠ¤ ì‚­ì œ í™•ì¸
        function confirmDeleteBox(boxNumber, boxSize) {
            if (!currentOrder) return;
            
            const boxInfo = `${boxNumber}-${boxSize}`;
            
            if (confirm(`${boxInfo} ë°•ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ë°•ìŠ¤ì— í¬í•¨ëœ ëª¨ë“  ìƒí’ˆ ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                // í•´ë‹¹ ë°•ìŠ¤ì— í¬í•¨ëœ ëª¨ë“  ìƒí’ˆì˜ ìŠ¤ìº”ìˆ˜ëŸ‰ì„ 0ìœ¼ë¡œ ì„¤ì •
                const boxProductsPromises = currentOrder.ìƒí’ˆì •ë³´
                    .filter(product => product.ë°•ìŠ¤ì •ë³´ === boxInfo)
                    .map(product => {
                        return fetch('/api/scan/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                orderNumber: currentOrder.ë°œì£¼ë²ˆí˜¸,
                                barcode: product.ìƒí’ˆë°”ì½”ë“œ,
                                boxInfo: boxInfo,
                                scanCount: 0
                            })
                        });
                    });
                
                Promise.all(boxProductsPromises)
                    .then(() => {
                        alert(`${boxInfo} ë°•ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        loadOrder();  // ë³€ê²½ ì‚¬í•­ ë°˜ì˜ì„ ìœ„í•´ ë°œì£¼ì„œ ë‹¤ì‹œ ë¡œë“œ
                    })
                    .catch(error => {
                        alert(`ë°•ìŠ¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    });
            }
        }

        // ë°•ìŠ¤ ì„ íƒ í™•ì¸ ë° ë°”ì½”ë“œ ì…ë ¥ í™œì„±í™”
        function checkBoxSelection() {
            const boxNumber = document.getElementById('boxNumber').value;
            const boxSize = document.getElementById('boxSize').value;
            
            if (boxNumber && boxSize) {
                // ë°”ì½”ë“œ ì…ë ¥ í•„ë“œì™€ ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œ í™œì„±í™”
                document.getElementById('barcode').disabled = false;
                document.getElementById('quantity').disabled = false;
                document.querySelector('.scan-btn[onclick="scanBarcode()"]').disabled = false;
                // í˜„ì¬ ì„ íƒëœ ë°•ìŠ¤ ì •ë³´ í‘œì‹œ
                document.getElementById('currentBoxText').textContent = `${boxNumber}-${boxSize}`;
                document.getElementById('currentBoxInfo').style.display = 'block';
                // ë°”ì½”ë“œ ì…ë ¥ì— í¬ì»¤ìŠ¤
                document.getElementById('barcode').focus();
            } else {
                // ë°”ì½”ë“œ ì…ë ¥ í•„ë“œì™€ ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™”
                document.getElementById('barcode').disabled = true;
                document.getElementById('quantity').disabled = true;
                document.querySelector('.scan-btn[onclick="scanBarcode()"]').disabled = true;
                document.getElementById('currentBoxInfo').style.display = 'none';
            }
        }

        async function scanBarcode() {
            if (!currentOrder) {
                alert('ë¨¼ì € ë°œì£¼ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.');
                return;
            }
            
            const boxNumber = document.getElementById('boxNumber').value;
            const boxSize = document.getElementById('boxSize').value;
            
            if (!boxNumber || !boxSize) {
                alert('ë°•ìŠ¤ ë²ˆí˜¸ì™€ ë°•ìŠ¤ í¬ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const barcode = document.getElementById('barcode').value;
            if (!barcode) {
                alert('ë°”ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ìˆ˜ëŸ‰ì„ ì‚¬ìš©
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            if (quantity <= 0) {
                alert('ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            try {
                const boxInfo = `${boxNumber}-${boxSize}`;

                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderNumber: currentOrder.ë°œì£¼ë²ˆí˜¸,
                        barcode: barcode,
                        boxNumber: boxNumber,
                        boxSize: boxSize,
                        boxInfo: boxInfo,
                        quantity: quantity
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ìŠ¤ìº”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const result = await response.json();
                lastScannedBarcode = barcode;
                
                // ë°”ì½”ë“œ ê²°ê³¼ ì˜ì—­ ì—…ë°ì´íŠ¸
                updateBarcodeResult(result);
                
                // ê²°ê³¼ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                const tbody = document.getElementById('productList');
                tbody.innerHTML = '';
                
                // ìƒí’ˆ ì •ë³´ í‘œì‹œ (ë°•ìŠ¤ì •ë³´ê°€ ì—†ëŠ” ì›ë³¸ ìƒí’ˆë§Œ í‘œì‹œ)
                result.ìƒí’ˆì •ë³´
                    .filter(product => !product.ë°•ìŠ¤ì •ë³´)
                    .forEach(product => {
                        const row = document.createElement('tr');
                        // ìŠ¤ìº” ìƒíƒœì— ë”°ë¥¸ í–‰ ìƒ‰ìƒ ì„¤ì •
                        if (product.ìŠ¤ìº”ìˆ˜ëŸ‰ >= product.í™•ì •ìˆ˜ëŸ‰) {
                            row.className = 'scan-complete';
                        } else if (product.ìŠ¤ìº”ìˆ˜ëŸ‰ > 0) {
                            row.className = 'scan-partial';
                        } else {
                            row.className = 'scan-none';
                        }
                        
                        row.innerHTML = `
                            <td>${product.ìƒí’ˆë°”ì½”ë“œ}</td>
                            <td>${product.ìƒí’ˆì´ë¦„}</td>
                            <td>${product.í™•ì •ìˆ˜ëŸ‰}</td>
                            <td>${product.ìŠ¤ìº”ìˆ˜ëŸ‰ || 0}</td>
                            <td>${product.ìœ„ì¹˜ || '-'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                
                // ë°•ìŠ¤ ì •ë³´ ë§µ ì—…ë°ì´íŠ¸
                boxInfoMap.clear();
                result.ìƒí’ˆì •ë³´
                    .filter(product => product.ë°•ìŠ¤ì •ë³´)
                    .forEach(product => {
                        const boxInfo = product.ë°•ìŠ¤ì •ë³´;
                        if (!boxInfoMap.has(boxInfo)) {
                            const [boxNumber, boxSize] = boxInfo.split('-');
                            boxInfoMap.set(boxInfo, {
                                boxNumber,
                                boxSize,
                                products: []
                            });
                        }
                    });
                
                // ë°•ìŠ¤ ì •ë³´ UI ì—…ë°ì´íŠ¸
                updateBoxInfoUI();
                
                // ì„±ê³µ íš¨ê³¼ìŒ ì¬ìƒ
                playSuccessSound();
                
                // ë°”ì½”ë“œ í•„ë“œì™€ ìˆ˜ëŸ‰ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('barcode').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('barcode').focus();
            } catch (error) {
                // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                document.getElementById('barcodeResult').innerHTML = `<div class="error-message">${error.message}</div>`;
                
                // í•´ë‹¹ ë°”ì½”ë“œê°€ ë°œì£¼ì„œì— ì—†ëŠ” ê²½ìš° ìƒí’ˆ ì •ë³´ ì¡°íšŒ ë° í‘œì‹œ
                if (error.message.includes('ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
                    // ê²½ê³ ìŒ ì¬ìƒ (ê°•ì¡°)
                    playWarningSound();
                    
                    try {
                        console.log('ë°”ì½”ë“œ ì •ë³´ ì¡°íšŒ ì‹œë„:', barcode);
                        const productResponse = await fetch(`/api/products/barcode/${barcode}`);
                        console.log('API ì‘ë‹µ ìƒíƒœ:', productResponse.status, productResponse.ok);
                        
                        if (productResponse.ok) {
                            const productData = await productResponse.json();
                            console.log('ì°¾ì€ ìƒí’ˆ ì •ë³´:', productData);
                            
                            // ìƒí’ˆ ì •ë³´ í‘œì‹œ (ë” ëª…í™•í•˜ê²Œ)
                            document.getElementById('barcodeResult').innerHTML = `
                                <div class="error-message">í•´ë‹¹ ë°”ì½”ë“œì˜ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                                <div class="product-detail">
                                    <strong>${productData.ìƒí’ˆë°”ì½”ë“œ}</strong> : ${productData.ìƒí’ˆì´ë¦„}
                                </div>
                            `;
                        } else {
                            // API í˜¸ì¶œì€ ì„±ê³µí–ˆì§€ë§Œ ìƒí’ˆì„ ì°¾ì§€ ëª»í•œ ê²½ìš°
                            console.log('ìƒí’ˆì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
                            document.getElementById('barcodeResult').innerHTML = `
                                <div class="error-message">í•´ë‹¹ ë°”ì½”ë“œì˜ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                                <div class="product-detail">
                                    <strong>${barcode}</strong> - ë“±ë¡ë˜ì§€ ì•Šì€ ìƒí’ˆì…ë‹ˆë‹¤.
                                </div>
                            `;
                        }
                    } catch (productError) {
                        console.error('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', productError);
                        document.getElementById('barcodeResult').innerHTML = `
                            <div class="error-message">í•´ë‹¹ ë°”ì½”ë“œì˜ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                            <div class="product-detail">
                                <strong>${barcode}</strong> - ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                            </div>
                        `;
                    }
                } else if (error.message.includes('ì´ë¯¸ í™•ì • ìˆ˜ëŸ‰ë§Œí¼ ìŠ¤ìº”ë˜ì—ˆìŠµë‹ˆë‹¤')) {
                    // ìˆ˜ëŸ‰ ì´ˆê³¼ ì˜¤ë¥˜ ì‹œ ê²½ê³ ìŒ ì¬ìƒ
                    playWarningSound();
                    document.getElementById('barcodeResult').innerHTML = `
                        <div class="error-message">${error.message}</div>
                    `;
                } else {
                    // ê·¸ ì™¸ ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
                    document.getElementById('barcodeResult').innerHTML = `
                        <div class="error-message">${error.message}</div>
                    `;
                }
                
                document.getElementById('barcode').value = '';
                document.getElementById('barcode').focus();
            }
        }

        function updateBarcodeResult(data) {
            // ìŠ¤ìº”ëœ ë°”ì½”ë“œì— í•´ë‹¹í•˜ëŠ” ìƒí’ˆ ì°¾ê¸°
            const scannedProduct = data.ìƒí’ˆì •ë³´.find(product => product.ìƒí’ˆë°”ì½”ë“œ === lastScannedBarcode && !product.ë°•ìŠ¤ì •ë³´);
            
            if (!scannedProduct) {
                document.getElementById('barcodeResult').innerHTML = `<div class="error-message">í•´ë‹¹ ë°”ì½”ë“œì˜ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
                playWarningSound();
                return;
            }
            
            const product = scannedProduct;
            const scanCount = product.ìŠ¤ìº”ìˆ˜ëŸ‰ || 0;
            const confirmedCount = product.í™•ì •ìˆ˜ëŸ‰ || 0;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            let countClass = '';
            if (scanCount >= confirmedCount) {
                countClass = 'count-complete';
                // ìˆ˜ëŸ‰ì´ ì¶©ì¡±ëœ ê²½ìš° íš¨ê³¼ìŒ ì¬ìƒ
                playSuccessSound();
            } else if (scanCount > 0) {
                countClass = 'count-partial';
            }
            
            document.getElementById('barcodeResult').innerHTML = `
                <div class="success-message">${quantity}ê°œê°€ ìŠ¤ìº”ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                <div class="barcode-display">${product.ìƒí’ˆë°”ì½”ë“œ}</div>
                <div class="product-name">${product.ìƒí’ˆì´ë¦„}</div>
                <div class="scan-count ${countClass}">${scanCount} / ${confirmedCount}</div>
            `;
        }

        function updateProductList(products) {
            const tbody = document.getElementById('productList');
            tbody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.ìƒí’ˆë°”ì½”ë“œ}</td>
                    <td>${product.ìƒí’ˆì´ë¦„}</td>
                    <td>${product.í™•ì •ìˆ˜ëŸ‰}</td>
                    <td>${product.ìŠ¤ìº”ìˆ˜ëŸ‰ || 0}</td>
                    <td>${product.ìœ„ì¹˜ || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ì´ˆê¸° ì„¤ì •
        document.getElementById('boxNumber').disabled = true;
        document.getElementById('boxSize').disabled = true;
        
        // ë°•ìŠ¤ ì„ íƒ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        document.getElementById('boxNumber').addEventListener('change', function() {
            const boxNumber = this.value;
            const boxSizeSelect = document.getElementById('boxSize');
            
            // ë°•ìŠ¤ ë²ˆí˜¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            for (const [key, info] of boxInfoMap.entries()) {
                if (info.boxNumber === boxNumber) {
                    // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°•ìŠ¤ ë²ˆí˜¸ë©´ í•´ë‹¹ í¬ê¸°ë¡œ ìë™ ì„ íƒ
                    boxSizeSelect.value = info.boxSize;
                    boxSizeSelect.disabled = true; // ë³€ê²½ ë¶ˆê°€ëŠ¥í•˜ê²Œ ì„¤ì •
                    
                    // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                    alert(`${boxNumber}ì˜ ë°•ìŠ¤í¬ê¸°ëŠ” ì´ë¯¸ ${info.boxSize}ë¡œ ì§€ì •ë˜ì–´ ìˆì–´ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    break;
                } else {
                    // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°•ìŠ¤ë©´ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
                    boxSizeSelect.disabled = false;
                }
            }
            
            checkBoxSelection();
        });

        // ë°•ìŠ¤ í¬ê¸° ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
        document.getElementById('boxSize').addEventListener('change', checkBoxSelection);
        
        // ë°”ì½”ë“œ ì…ë ¥ í•„ë“œì—ì„œ ì—”í„°í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.getElementById('barcode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                scanBarcode();
            }
        });
        
        // ë°œì£¼ë²ˆí˜¸ ì…ë ¥ í•„ë“œì—ì„œ ì—”í„°í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.getElementById('orderNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                loadOrder();
            }
        });
        
        // ì†Œì¼“ ì—°ê²°ì„ í†µí•œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        const socket = io();
        socket.on('scan-update', function(data) {
            if (currentOrder && currentOrder.ë°œì£¼ë²ˆí˜¸ === data.orderNumber) {
                // ë°œì£¼ì„œ ë‹¤ì‹œ ë¡œë“œ (ìµœì‹  ì •ë³´ ë°˜ì˜)
                loadOrder();
            }
        });

        // ë°•ìŠ¤ ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        let editingBoxInfo = null;

        function openEditBoxModal(boxNumber, boxSize) {
            editingBoxInfo = { boxNumber, boxSize };
            document.getElementById('currentBoxInfoText').textContent = `${boxNumber} - ${boxSize}`;
            document.getElementById('editBoxNumber').value = boxNumber;
            document.getElementById('editBoxSize').value = boxSize;
            document.getElementById('editBoxModal').style.display = 'block';
        }

        function closeEditBoxModal() {
            document.getElementById('editBoxModal').style.display = 'none';
            editingBoxInfo = null;
        }

        async function submitBoxEdit() {
            const newBoxNumber = document.getElementById('editBoxNumber').value;
            const newBoxSize = document.getElementById('editBoxSize').value;
            
            if (!newBoxNumber || !newBoxSize) {
                alert('ë°•ìŠ¤ ë²ˆí˜¸ì™€ í¬ê¸°ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë‹¤ë¥¸ ë°•ìŠ¤ë²ˆí˜¸ì™€ ì¤‘ë³µ ì²´í¬
            let isDuplicate = false;
            boxInfoMap.forEach((info, boxInfo) => {
                if (info.boxNumber === newBoxNumber && info.boxNumber !== editingBoxInfo.boxNumber) {
                    isDuplicate = true;
                }
            });
            
            if (isDuplicate) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°•ìŠ¤ë²ˆí˜¸ì…ë‹ˆë‹¤.');
                return;
            }
            
            try {
                const response = await fetch('/api/scan/updateBox', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderNumber: currentOrder.ë°œì£¼ë²ˆí˜¸,
                        oldBoxNumber: editingBoxInfo.boxNumber,
                        oldBoxSize: editingBoxInfo.boxSize,
                        newBoxNumber: newBoxNumber,
                        newBoxSize: newBoxSize
                    })
                });

                if (!response.ok) {
                    throw new Error('ë°•ìŠ¤ ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                // ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ë©´ ë°œì£¼ì„œ ë‹¤ì‹œ ë¡œë“œ
                await loadOrder();
                closeEditBoxModal();
            } catch (error) {
                alert(error.message);
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const editBoxModal = document.getElementById('editBoxModal');
            const boxProductsModal = document.getElementById('boxProductsModal');
            
            if (event.target === editBoxModal) {
                closeEditBoxModal();
            }
            
            if (event.target === boxProductsModal) {
                closeBoxProductsModal();
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeEditBoxModal();
                closeBoxProductsModal();
            }
        });
    </script>
</body>
</html> 