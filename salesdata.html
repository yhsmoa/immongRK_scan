<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íŒë§¤ë°ì´í„°</title>
    <style>
        /* Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 40px 20px;
        }

        /* Top Menu */
        .top-menu {
            background-color: #333;
            padding: 10px 0;
            margin: -40px -20px 20px -20px;
        }

        .menu-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 20px;
        }

        .menu-item {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 3px;
        }

        .menu-item:hover {
            background-color: #444;
        }

        .menu-item.active {
            background-color: #666;
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        /* Content Section */
        .content {
            background-color: transparent;
            padding: 0;
        }

        /* Control Section (Upload Buttons) */
        .upload-section {
            margin-bottom: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 16px;
            border: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Button Styles */
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 160px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
            min-width: 120px;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .discontinue-btn {
            background: #3498db;
            color: white;
        }

        .discontinue-btn:hover {
            background: #2980b9;
        }

        .location-save-btn {
            background: #3498db;
            color: white;
        }

        .location-save-btn:hover {
            background: #2980b9;
        }

        .upload-btn {
            background: #3498db;
            color: white;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        /* Search Section */
        .search-section {
            margin-bottom: 20px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 16px;
            border: 1px solid #e9ecef;
        }

        .search-form {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .search-input {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .search-form select.search-input {
            min-width: 150px;
        }

        .search-form > div {
            flex: 1;
            display: flex;
        }

        .search-form input.search-input {
            width: 100%;
        }

        .search-btn {
            background: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 100px;
        }

        .search-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        /* Table Container */
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background: #3498db;
            color: white;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            background: #3498db;
            z-index: 10;
            border-bottom: 1px solid #2980b9;
        }

        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        /* íŠ¹ì • ì—´ ê°€ìš´ë° ì •ë ¬ */
        th:nth-child(4), td:nth-child(4), /* ë°œì£¼ */
        th:nth-child(5), td:nth-child(5), /* ì¿ íŒ¡ì˜ˆì¸¡ */
        th:nth-child(6), td:nth-child(6), /* ì°½ê³ ì¬ê³  */
        th:nth-child(7), td:nth-child(7), /* ì¿ íŒ¡ ì¬ê³  */
        th:nth-child(8), td:nth-child(8), /* ì£¼ë¬¸ê°œìˆ˜ */
        th:nth-child(9), td:nth-child(9)  /* ì‚¬ì… */
        {
            text-align: center;
        }

        tbody tr:hover {
            background: #f5f5f5;
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        tbody tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        /* Checkbox Styles */
        .item-checkbox, #selectAll {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            font-weight: bold;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden Utility */
        .hidden {
            display: none;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            width: 40px;
            height: 40px;
            min-width: auto;
            padding: 0;
            box-shadow: none;
        }

        .modal-close:hover {
            color: #333;
            transform: none;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-textarea {
            width: 100%;
            min-height: 300px;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .modal-textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .modal-btn-cancel:hover {
            background: #7f8c8d;
        }

        .modal-btn-submit {
            background: #3498db;
            color: white;
        }

        .modal-btn-submit:hover {
            background: #2980b9;
        }

        /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
        .tooltip {
            position: relative;
            cursor: pointer;
        }

        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-line;
            margin-bottom: 5px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            min-width: 150px;
            text-align: center;
        }

        .tooltip:hover .tooltip-content {
            opacity: 1;
        }

        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #2c3e50;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }

            .top-menu {
                margin: -20px -10px 20px -10px;
            }

            .container {
                padding: 20px;
                border-radius: 10px;
            }

            .upload-section,
            .search-section {
                padding: 15px;
                border-radius: 10px;
            }

            .search-form {
                flex-direction: column;
            }

            .search-form select.search-input,
            .search-form input.search-input {
                width: 100%;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                max-height: 80vh;
                overflow-y: auto;
            }

            table {
                font-size: 14px;
                min-width: 450px;
            }

            th, td {
                padding: 8px;
            }

            button {
                padding: 10px 20px;
                font-size: 13px;
            }

            .upload-section {
                justify-content: stretch;
            }

            .upload-section button {
                flex: 1;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading-screen hidden" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">íŒë§¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <!-- ì‹œíŠ¸ ì£¼ë¬¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="sheetOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ì‹œíŠ¸ ì£¼ë¬¸ ë°ì´í„° ì…ë ¥</h2>
                <button class="modal-close" onclick="ModalManager.closeSheetOrderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 10px; font-size: 14px;">
                    êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.
                </p>
                <textarea id="sheetDataInput" class="modal-textarea" placeholder="ì—¬ê¸°ì— êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê¸°..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="ModalManager.closeSheetOrderModal()">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-submit" onclick="EventHandlers.handleSheetOrderSubmit()">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <div id="header-container"></div>
    <div class="container">
        <div class="content">
            <div class="upload-section">
                <button class="upload-btn">â¬†ï¸ ë°œì£¼ì„œ.xlsx</button>
                <button class="upload-btn">â¬†ï¸ ì¿ íŒ¡ ì˜ˆì¸¡.xlsx</button>
                <button class="upload-btn">ì‹œíŠ¸ ì£¼ë¬¸</button>
                <button class="upload-btn">â¬†ï¸ ì°½ê³  ì¬ê³ .xlsx</button>
                <button class="discontinue-btn">ğŸ“¡ ì¿ íŒ¡ ì¬ê³ </button>
                <button class="delete-btn">ì‚­ì œ</button>
            </div>

            <div class="search-section">
                <form class="search-form">
                    <select class="search-input">
                        <option value="ì „ì²´" selected>ì „ì²´</option>
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ì¼ì‹œì¤‘ë‹¨">ì¼ì‹œì¤‘ë‹¨</option>
                        <option value="ë¶ˆê°€">ë¶ˆê°€</option>
                    </select>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" class="search-input" placeholder="SKU ID, ë°”ì½”ë“œ, ìƒí’ˆëª… ê²€ìƒ‰ (ì½¤ë§ˆë¡œ ì—¬ëŸ¬ ê°œ ê²€ìƒ‰ ê°€ëŠ¥)" style="flex: 1;">
                    </div>
                    <button type="submit" class="search-btn">ê²€ìƒ‰</button>
                </form>
            </div>

            <div class="table-container">
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>SKU / Barcode</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>ë°œì£¼</th>
                            <th>ì¿ íŒ¡ì˜ˆì¸¡</th>
                            <th>ì°½ê³ ì¬ê³ </th>
                            <th>ì¿ íŒ¡ ì¬ê³ </th>
                            <th>ì£¼ë¬¸ê°œìˆ˜</th>
                            <th>ì‚¬ì…</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ========================================
        // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        // ========================================
        const AppData = {
            salesData: new Map(), // key: SKU, value: ìƒí’ˆ ê°ì²´

            // ìƒí’ˆ ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸
            addOrUpdateProduct(product, createIfNotExists = true) {
                const sku = product.sku;
                if (this.salesData.has(sku)) {
                    // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë³‘í•©
                    const existing = this.salesData.get(sku);
                    this.salesData.set(sku, { ...existing, ...product });
                } else if (createIfNotExists) {
                    // ìƒˆë¡œìš´ ë°ì´í„° (createIfNotExistsê°€ trueì¼ ë•Œë§Œ)
                    this.salesData.set(sku, product);
                }
            },

            // ë°”ì½”ë“œë¡œ ìƒí’ˆ ì°¾ê¸°
            findByBarcode(barcode) {
                for (const [sku, product] of this.salesData.entries()) {
                    if (product.barcode === barcode) {
                        return product;
                    }
                }
                return null;
            },

            // ë°œì£¼ ìˆ˜ëŸ‰ ì¶”ê°€ (ëˆ„ì )
            addOrderQuantity(sku, quantity) {
                if (this.salesData.has(sku)) {
                    const product = this.salesData.get(sku);
                    product.orderQty = (product.orderQty || 0) + quantity;
                }
            },

            // ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            getAllProducts() {
                return Array.from(this.salesData.values());
            },

            // ë°ì´í„° ì´ˆê¸°í™”
            clear() {
                this.salesData.clear();
            }
        };

        // ========================================
        // êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹°
        // ========================================
        const SheetUtils = {
            // TSV ë°ì´í„° íŒŒì‹± (íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ ë°ì´í„°)
            parseSheetData(text) {
                const lines = text.trim().split('\n');
                const result = [];

                // 3í–‰ë¶€í„° ë°ì´í„° (1~2í–‰ì€ í—¤ë”)
                for (let i = 2; i < lines.length; i++) {
                    const cells = lines[i].split('\t');
                    if (cells.length < 28) continue; // ìµœì†Œ ABì—´(27)ê¹Œì§€ ìˆì–´ì•¼ í•¨

                    const barcode = cells[10]?.trim(); // Kì—´ (index 10)
                    const progressQty = parseInt(cells[20]) || 0; // Uì—´ (index 20)
                    const shipQty1 = parseInt(cells[23]) || 0; // Xì—´ (index 23)
                    const shipQty2 = parseInt(cells[24]) || 0; // Yì—´ (index 24)
                    const shipNumber = cells[27]?.trim() || ''; // ABì—´ (index 27)
                    const boxCount = cells[28]?.trim() || ''; // ACì—´ (index 28)

                    if (!barcode) continue;

                    result.push({
                        barcode,
                        progressQty,
                        shipQty1,
                        shipQty2,
                        totalShipQty: shipQty1 + shipQty2,
                        shipNumber,
                        boxCount,
                        shipInfo: shipNumber && boxCount ? `${shipNumber} - ${boxCount}` : ''
                    });
                }

                return result;
            },

            // ë°”ì½”ë“œë³„ë¡œ ë°ì´í„° ë³‘í•© (ë™ì¼ ë°”ì½”ë“œëŠ” ìˆ˜ëŸ‰ í•©ì‚°, shipInfo ë³‘í•©)
            mergeByBarcode(sheetData) {
                const merged = new Map();

                sheetData.forEach(item => {
                    if (merged.has(item.barcode)) {
                        const existing = merged.get(item.barcode);
                        existing.totalShipQty += item.totalShipQty;
                        if (item.shipInfo) {
                            existing.shipInfoList.push(item.shipInfo);
                        }
                    } else {
                        merged.set(item.barcode, {
                            barcode: item.barcode,
                            totalShipQty: item.totalShipQty,
                            shipInfoList: item.shipInfo ? [item.shipInfo] : []
                        });
                    }
                });

                return merged;
            }
        };

        // ========================================
        // ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹°
        // ========================================
        const ExcelUtils = {
            // íŒŒì¼ë“¤ì„ ì½ì–´ì„œ ë°œì£¼ì„œ ë°ì´í„° ì¶”ì¶œ
            async processOrderFiles(files) {
                const orderData = new Map(); // key: SKU, value: {sku, barcode, name, qty}

                for (const file of files) {
                    try {
                        const data = await this.readExcelFile(file);
                        this.mergeOrderData(data, orderData);
                    } catch (error) {
                        console.error(`íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜ (${file.name}):`, error);
                        throw error;
                    }
                }

                return Array.from(orderData.values());
            },

            // ì¿ íŒ¡ ì˜ˆì¸¡ íŒŒì¼ ì²˜ë¦¬
            async processForecastFiles(files) {
                const forecastData = new Map(); // key: SKU, value: forecast count

                for (const file of files) {
                    try {
                        const data = await this.readExcelFile(file);
                        this.mergeForecastData(data, forecastData);
                    } catch (error) {
                        console.error(`íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜ (${file.name}):`, error);
                        throw error;
                    }
                }

                return forecastData;
            },

            // ì—‘ì…€ íŒŒì¼ ì½ê¸°
            readExcelFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            resolve(jsonData);
                        } catch (error) {
                            reject(error);
                        }
                    };

                    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                    reader.readAsArrayBuffer(file);
                });
            },

            // ë°œì£¼ì„œ ë°ì´í„° ë³‘í•© (ë™ì¼ SKUëŠ” ìˆ˜ëŸ‰ í•©ì‚°)
            mergeOrderData(excelData, orderMap) {
                // 2í–‰ë¶€í„° ë°ì´í„° (1í–‰ì€ í—¤ë”)
                for (let i = 1; i < excelData.length; i++) {
                    const row = excelData[i];
                    if (!row || row.length < 8) continue;

                    const sku = row[4]?.toString().trim(); // Eì—´ (index 4)
                    const barcode = row[5]?.toString().trim(); // Fì—´
                    const name = row[6]?.toString().trim(); // Gì—´
                    const qty = parseInt(row[7]) || 0; // Hì—´

                    if (!sku) continue;

                    if (orderMap.has(sku)) {
                        // ë™ì¼ SKUê°€ ìˆìœ¼ë©´ ìˆ˜ëŸ‰ë§Œ í•©ì‚°
                        const existing = orderMap.get(sku);
                        existing.qty += qty;
                    } else {
                        // ìƒˆë¡œìš´ SKU
                        orderMap.set(sku, {
                            sku,
                            barcode: barcode || '',
                            name: name || '',
                            qty
                        });
                    }
                }
            },

            // ì¿ íŒ¡ ì˜ˆì¸¡ ë°ì´í„° ë³‘í•©
            mergeForecastData(excelData, forecastMap) {
                // 4í–‰ë¶€í„° ë°ì´í„° (1~3í–‰ì€ í—¤ë”)
                for (let i = 3; i < excelData.length; i++) {
                    const row = excelData[i];
                    if (!row || row.length < 4) continue;

                    const sku = row[1]?.toString().trim(); // Bì—´ (index 1)
                    const forecast = row[3]?.toString().trim() || '0'; // Dì—´ (index 3) - í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ìœ ì§€

                    if (!sku) continue;

                    forecastMap.set(sku, forecast);
                }
            }
        };

        // ========================================
        // UI ë Œë”ë§
        // ========================================
        const UIRenderer = {
            // í…Œì´ë¸” ë Œë”ë§
            renderTable() {
                const tbody = document.querySelector('#salesTable tbody');
                tbody.innerHTML = '';

                const products = AppData.getAllProducts();

                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 50px; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                products.forEach((product, index) => {
                    const row = this.createTableRow(product, index);
                    tbody.appendChild(row);
                });
            },

            // í…Œì´ë¸” í–‰ ìƒì„±
            createTableRow(product, index) {
                const tr = document.createElement('tr');

                const skuBarcode = `${product.sku || '-'}\n${product.barcode || '-'}`;

                // ì£¼ë¬¸ê°œìˆ˜ ì…€ (íˆ´íŒ í¬í•¨)
                let orderCountCell;
                if (product.orderCount && product.shipInfoList && product.shipInfoList.length > 0) {
                    const tooltipContent = product.shipInfoList.join('\n');
                    orderCountCell = `
                        <td class="tooltip">
                            ${product.orderCount}
                            <div class="tooltip-content">${tooltipContent}</div>
                        </td>
                    `;
                } else {
                    orderCountCell = `<td>${product.orderCount || '-'}</td>`;
                }

                tr.innerHTML = `
                    <td><input type="checkbox" class="item-checkbox" data-sku="${product.sku}"></td>
                    <td style="white-space: pre-line; font-family: monospace; font-size: 13px;">${skuBarcode}</td>
                    <td>${product.name || '-'}</td>
                    <td>${product.orderQty || 0}</td>
                    <td>${product.coupangForecast || '-'}</td>
                    <td>${product.warehouseStock || '-'}</td>
                    <td>${product.coupangStock || '-'}</td>
                    ${orderCountCell}
                    <td>${product.purchase || '-'}</td>
                `;

                return tr;
            },

            // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
            showLoading(show, message = 'ì²˜ë¦¬ ì¤‘...') {
                const loadingScreen = document.getElementById('loadingScreen');
                const loadingText = loadingScreen.querySelector('.loading-text');
                loadingText.textContent = message;

                if (show) {
                    loadingScreen.classList.remove('hidden');
                } else {
                    loadingScreen.classList.add('hidden');
                }
            }
        };

        // ========================================
        // ëª¨ë‹¬ ê´€ë¦¬
        // ========================================
        const ModalManager = {
            openSheetOrderModal() {
                document.getElementById('sheetOrderModal').classList.add('active');
                document.getElementById('sheetDataInput').value = '';
                document.getElementById('sheetDataInput').focus();
            },

            closeSheetOrderModal() {
                document.getElementById('sheetOrderModal').classList.remove('active');
            }
        };

        // ========================================
        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        // ========================================
        const EventHandlers = {
            // ë°œì£¼ì„œ ì—…ë¡œë“œ
            async handleOrderUpload() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx, .xls';
                input.multiple = true;

                input.onchange = async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;

                    try {
                        UIRenderer.showLoading(true, 'ë°œì£¼ì„œ íŒŒì¼ ì²˜ë¦¬ ì¤‘...');

                        // ì—‘ì…€ íŒŒì¼ë“¤ ì²˜ë¦¬
                        const orderData = await ExcelUtils.processOrderFiles(files);

                        // AppDataì— ì¶”ê°€ (ë©”ëª¨ë¦¬ì— ì „ë¶€ ë³´ê´€)
                        orderData.forEach(item => {
                            AppData.addOrUpdateProduct({
                                sku: item.sku,
                                barcode: item.barcode,
                                name: item.name,
                                orderQty: item.qty
                            });
                        });

                        // í…Œì´ë¸” ë Œë”ë§
                        UIRenderer.renderTable();
                    } catch (error) {
                        console.error('ë°œì£¼ì„œ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    } finally {
                        UIRenderer.showLoading(false);
                    }
                };

                input.click();
            },

            // ì¿ íŒ¡ ì˜ˆì¸¡ ì—…ë¡œë“œ
            async handleForecastUpload() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx, .xls';
                input.multiple = true;

                input.onchange = async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;

                    try {
                        UIRenderer.showLoading(true, 'ì¿ íŒ¡ ì˜ˆì¸¡ íŒŒì¼ ì²˜ë¦¬ ì¤‘...');

                        // ì—‘ì…€ íŒŒì¼ë“¤ ì²˜ë¦¬
                        const forecastData = await ExcelUtils.processForecastFiles(files);

                        // AppDataì— ì¶”ê°€ (ê¸°ì¡´ SKUë§Œ ì—…ë°ì´íŠ¸, ìƒˆ SKUëŠ” ë©”ëª¨ë¦¬ì—ë§Œ ë³´ê´€í•˜ê³  í…Œì´ë¸”ì— í‘œì‹œ ì•ˆ í•¨)
                        forecastData.forEach((forecast, sku) => {
                            AppData.addOrUpdateProduct({
                                sku: sku,
                                coupangForecast: forecast
                            }, false); // createIfNotExists = false
                        });

                        // í…Œì´ë¸” ë Œë”ë§
                        UIRenderer.renderTable();
                    } catch (error) {
                        console.error('ì¿ íŒ¡ ì˜ˆì¸¡ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    } finally {
                        UIRenderer.showLoading(false);
                    }
                };

                input.click();
            },

            // ì¿ íŒ¡ ì¬ê³  ì¡°íšŒ (Supabaseì—ì„œ)
            async handleCoupangStock() {
                try {
                    UIRenderer.showLoading(true, 'ì¿ íŒ¡ ì¬ê³  ì¡°íšŒ ì¤‘...');

                    // í˜„ì¬ í…Œì´ë¸”ì— ìˆëŠ” ëª¨ë“  ìƒí’ˆëª… ì¶”ì¶œ
                    const products = AppData.getAllProducts();
                    const productNames = products
                        .map(p => p.name)
                        .filter(name => name && name !== '-');

                    if (productNames.length === 0) {
                        console.error('ì¡°íšŒí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    console.log(`ì¿ íŒ¡ ì¬ê³  ì¡°íšŒ ì‹œì‘: ${productNames.length}ê°œ ìƒí’ˆ`);

                    // ì„œë²„ì— ì¬ê³  ì¡°íšŒ ìš”ì²­
                    const response = await fetch('/api/salesdata/coupang-stock', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ productNames })
                    });

                    if (!response.ok) {
                        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                    }

                    const result = await response.json();

                    if (result.success) {
                        // ì¬ê³  ì •ë³´ë¥¼ AppDataì— ì—…ë°ì´íŠ¸
                        Object.entries(result.stocks).forEach(([productName, stock]) => {
                            // ìƒí’ˆëª…ìœ¼ë¡œ í•´ë‹¹ ìƒí’ˆ ì°¾ê¸°
                            const product = products.find(p => p.name === productName);
                            if (product) {
                                AppData.addOrUpdateProduct({
                                    sku: product.sku,
                                    coupangStock: stock
                                }, false);
                            }
                        });

                        // í…Œì´ë¸” ë Œë”ë§
                        UIRenderer.renderTable();

                        console.log(`ì¿ íŒ¡ ì¬ê³  ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${Object.keys(result.stocks).length}ê°œ ë§¤ì¹­`);
                    }

                } catch (error) {
                    console.error('ì¿ íŒ¡ ì¬ê³  ì¡°íšŒ ì˜¤ë¥˜:', error);
                } finally {
                    UIRenderer.showLoading(false);
                }
            },

            // ì‹œíŠ¸ ì£¼ë¬¸ ë°ì´í„° ì œì¶œ
            handleSheetOrderSubmit() {
                try {
                    const sheetData = document.getElementById('sheetDataInput').value.trim();

                    if (!sheetData) {
                        console.error('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    UIRenderer.showLoading(true, 'ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ ì¤‘...');

                    // ë°ì´í„° íŒŒì‹±
                    const parsedData = SheetUtils.parseSheetData(sheetData);
                    console.log(`íŒŒì‹± ì™„ë£Œ: ${parsedData.length}ê°œ í–‰`);

                    // ë°”ì½”ë“œë³„ë¡œ ë³‘í•©
                    const mergedData = SheetUtils.mergeByBarcode(parsedData);
                    console.log(`ë³‘í•© ì™„ë£Œ: ${mergedData.size}ê°œ ë°”ì½”ë“œ`);

                    // AppDataì— ë§¤ì¹­ ë° ì—…ë°ì´íŠ¸
                    let matchedCount = 0;
                    mergedData.forEach((data, barcode) => {
                        const product = AppData.findByBarcode(barcode);
                        if (product) {
                            AppData.addOrUpdateProduct({
                                sku: product.sku,
                                orderCount: data.totalShipQty,
                                shipInfoList: data.shipInfoList
                            }, false);
                            matchedCount++;
                        }
                    });

                    console.log(`ë§¤ì¹­ ì™„ë£Œ: ${matchedCount}ê°œ ìƒí’ˆ`);

                    // í…Œì´ë¸” ë Œë”ë§
                    UIRenderer.renderTable();

                    // ëª¨ë‹¬ ë‹«ê¸°
                    ModalManager.closeSheetOrderModal();

                    UIRenderer.showLoading(false);

                } catch (error) {
                    console.error('ì‹œíŠ¸ ì£¼ë¬¸ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    UIRenderer.showLoading(false);
                }
            },

            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤
            handleSelectAll(e) {
                const checkboxes = document.querySelectorAll('.item-checkbox');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            }
        };

        // ========================================
        // ì´ˆê¸°í™”
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            // í—¤ë” ë¡œë“œ
            fetch('/header')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('header-container').innerHTML = html;
                });

            // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
            const buttons = document.querySelectorAll('.upload-section button');
            buttons[0].addEventListener('click', () => EventHandlers.handleOrderUpload()); // ë°œì£¼ì„œ.xlsx
            buttons[1].addEventListener('click', () => EventHandlers.handleForecastUpload()); // ì¿ íŒ¡ ì˜ˆì¸¡.xlsx
            buttons[2].addEventListener('click', () => ModalManager.openSheetOrderModal()); // ì‹œíŠ¸ ì£¼ë¬¸
            buttons[4].addEventListener('click', () => EventHandlers.handleCoupangStock()); // ì¿ íŒ¡ ì¬ê³ 

            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤
            document.getElementById('selectAll').addEventListener('change', EventHandlers.handleSelectAll);

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.getElementById('sheetOrderModal').addEventListener('click', (e) => {
                if (e.target.id === 'sheetOrderModal') {
                    ModalManager.closeSheetOrderModal();
                }
            });

            // ë¡œë”© ìˆ¨ê¹€
            UIRenderer.showLoading(false);
        });
    </script>
</body>
</html>
