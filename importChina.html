<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¿ íŒ¡ ë¡œì¼“ ì¤‘êµ­ì…ê³ </title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .top-menu {
            background-color: #fff;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .menu-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }
        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 3px;
            color: #333;
            text-decoration: none;
        }
        .menu-item:hover {
            background-color: #f0f0f0;
        }
        .menu-item.active {
            background-color: #e0e0e0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .upload-area.dragover {
            background-color: #f8f9fa;
            border-color: #4CAF50;
        }
        .upload-area p {
            margin: 15px 0 0;
            color: #666;
        }
        .upload-btn {
            padding: 10px 20px;
            background-color: #FF69B4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .upload-btn:hover {
            background-color: #FF1493;
        }
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .table th, .table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .table tr:hover {
            background-color: #f5f5f5;
        }
        .group-header, .subgroup-header, .item-row, .collapsed, .toggle-icon {
            display: none;
        }
        .button-container {
            margin-top: 20px;
            text-align: right;
        }
        .action-btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .action-btn:hover {
            background-color: #45a049;
        }
        .container h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .container h1 .flag {
            font-size: 1.2em;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            width: 400px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        .close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .close:hover {
            color: #000;
        }
        .modal-body {
            margin-bottom: 20px;
            text-align: center;
        }
        .modal-body input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .modal-footer {
            text-align: center;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 8px 16px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal-btn.confirm {
            background-color: #FF69B4;
            color: white;
        }
        .modal-btn.cancel {
            background-color: #ddd;
            color: #333;
        }
        .table th:nth-child(2),
        .table td:nth-child(2) {
            display: none;
        }
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .left-buttons {
            display: flex;
            gap: 10px;
        }
        
        .right-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .action-button:hover {
            opacity: 0.9;
        }
        
        .organize-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .order-organize-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .import1-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .import2-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .pdf-button {
            background-color: #2196F3;
            color: white;
        }
        
        .delete-button {
            background-color: #f44336;
            color: white;
        }
        
        .shipment-code-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .shipment-code-button:hover {
            background-color: #e9ecef;
        }
        
        .shipment-code-button.selected {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin: 0 auto;
            width: 90%;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .content, .content * {
                visibility: visible;
            }
            .content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .table {
                width: 100%;
                border-collapse: collapse;
                page-break-inside: auto;
                font-size: 9px !important;
            }
            .table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            .table th, .table td {
                border: 1px solid #000;
                padding: 4px;
                font-size: 9px !important;
                line-height: 1.2;
                white-space: nowrap;
            }
            .table th {
                background-color: #f2f2f2 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-weight: bold;
            }
            .table td:nth-child(5), /* ìƒí’ˆëª… */
            .table td:nth-child(8) { /* ì¶œê³ ì˜ˆì • */
                white-space: normal;
                max-width: 200px;
                word-break: break-word;
            }
            .button-group, .upload-container {
                display: none;
            }
            @page {
                size: A4 landscape;
                margin: 0.5cm;
            }
        }
        .table td:nth-child(8) { /* ì¶œê³ ì˜ˆì • ì—´ */
            white-space: pre-line;
            max-width: 300px;
            cursor: pointer;
        }
        .editable-cell {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 8px;
            min-height: 100px;
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
            font-size: inherit;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    <div class="container">
        <h1>ì¤‘êµ­ì…ê³  ê´€ë¦¬ <span class="flag">ğŸ‰</span></h1>
        <div class="content">
            <div class="button-group">
                <div class="left-buttons">
                    <button class="action-button delete-button" id="deleteButton">ì‚­ì œ</button>
                </div>
                <div class="right-buttons">
                    <button class="action-button organize-button" id="organizeButton">CN ì…ê³  ì •ë¦¬</button>
                    <button class="action-button import1-button" id="import1Button">ì…ê³ 1</button>
                    <button class="action-button import2-button" id="import2Button">ì…ê³ 2</button>
                    <button class="action-button order-organize-button" id="orderOrganizeButton">ì…ê³ 1/2 ì´ˆê¸°í™”</button>
                    <button class="action-button pdf-button" id="printButton">ì¸ì‡„</button>
                </div>
            </div>
            
            <div class="upload-container">
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Excel íŒŒì¼ ì—…ë¡œë“œ ğŸ²</button>
                    <p>ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</p>
                </div>
            </div>

            <!-- ì •ë ¬ ë“œë¡­ë°•ìŠ¤ ì¶”ê°€ -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                <div style="display: flex; align-items: center;">
                    <label for="sortDropdown" style="margin-right: 10px; font-weight: bold;">ì •ë ¬ ê¸°ì¤€:</label>
                    <select id="sortDropdown" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; background-color: #f9f9f9;">
                        <option value="none">- ì„ íƒ -</option>
                        <option value="boxName">ë°•ìŠ¤ë²ˆí˜¸</option>
                        <option value="orderNumber">ì¤‘êµ­ë²ˆí˜¸</option>
                        <option value="productName">ìƒí’ˆëª…</option>
                        <option value="availableOrders">ì¶œê³ ì˜ˆì •</option>
                        <option value="shippingDate">ì¶œê³ ì˜ˆì •ì¼</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ì¶œê³ ì½”ë“œ</th>
                            <th style="display: none;">íŒ”ë ›</th>
                            <th>ë°•ìŠ¤ëª…</th>
                            <th>ì¤‘êµ­ë²ˆí˜¸</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ë°”ì½”ë“œ</th>
                            <th>ì¶œê³ ì˜ˆì •</th>
                            <th>ì¶œê³ ì˜ˆì •ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                        <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì¶œê³ ë‚ ì§œ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="dateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì¶œê³ ì½”ë“œ ì…ë ¥</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <label for="shipmentCode">ì¶œê³ ì½”ë“œ:</label>
                <input type="text" id="shipmentCode" placeholder="ì¶œê³ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn confirm" onclick="confirmShipmentCode()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ ëª¨ë‹¬ -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>ì‚­ì œí•  ì¶œê³ ì½”ë“œ ì„ íƒ</h2>
            <div id="shipmentCodeList">
                <!-- ì¶œê³ ì½”ë“œ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            <div class="button-container">
                <button class="action-button delete-button" id="confirmDeleteButton">ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <!-- ì…ê³ 1 ëª¨ë‹¬ -->
    <div id="import1Modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì…ê³ 1 ì •ë¦¬</h2>
                <span class="close" onclick="closeImport1Modal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>ì¶œê³ ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                <div class="modal-grid" id="import1ShipmentCodeList">
                    <!-- ì¶œê³ ì½”ë“œ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ì…ê³ 2 ëª¨ë‹¬ -->
    <div id="import2Modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì…ê³ 2 ì •ë¦¬</h2>
                <span class="close" onclick="closeImport2Modal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>ì¶œê³ ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                <div class="modal-grid" id="import2ShipmentCodeList">
                    <!-- ì¶œê³ ì½”ë“œ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;

        // í—¤ë” ë¡œë“œ
        fetch('/header')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
            });

        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
        function showModal() {
            document.getElementById('dateModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('dateModal').style.display = 'none';
            selectedFile = null;
            document.getElementById('shipmentCode').value = '';
        }

        function confirmShipmentCode() {
            const shipmentCode = document.getElementById('shipmentCode').value.trim();
            if (!shipmentCode) {
                alert('ì¶œê³ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (selectedFile) {
                handleFileUpload(selectedFile, shipmentCode);
            }
            closeModal();
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedFile = files[0];
                showModal();
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                showModal();
            }
        });

        async function handleFileUpload(file, shipmentCode) {
            if (!file.name.endsWith('.xlsx')) {
                alert('Excel íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('shipmentCode', shipmentCode);

            try {
                const response = await fetch('/api/importChina/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                alert(data.message);
                loadImportData();
            } catch (error) {
                console.error('Error:', error);
                alert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì „ì—­ ë³€ìˆ˜ë¡œ ë°ì´í„° ì €ì¥
        let globalData = [];

        // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadImportData() {
            try {
                const response = await fetch('/api/importChina');
                if (!response.ok) {
                    throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
                const data = await response.json();
                console.log('ë¡œë“œëœ ë°ì´í„°:', data);
                globalData = data; // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥
                displayData(data);
            } catch (error) {
                console.error('Error loading data:', error);
                console.error('Error:', error);
            }
        }

        function displayData(data) {
            const tbody = document.getElementById('dataBody');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                
                // ì¶œê³ ì½”ë“œ
                const shipmentCodeCell = document.createElement('td');
                shipmentCodeCell.textContent = item.shipmentCode;
                row.appendChild(shipmentCodeCell);
                
                // íŒ”ë ›
                const palletCell = document.createElement('td');
                palletCell.textContent = item.pallet;
                row.appendChild(palletCell);
                
                // ë°•ìŠ¤ëª…
                const boxNameCell = document.createElement('td');
                boxNameCell.textContent = item.boxName;
                row.appendChild(boxNameCell);
                
                // ë°œì£¼ë²ˆí˜¸ (ì¤‘êµ­ë²ˆí˜¸)
                const orderNumberCell = document.createElement('td');
                orderNumberCell.textContent = item.orderNumber;
                row.appendChild(orderNumberCell);
                
                // ìƒí’ˆëª…
                const productNameCell = document.createElement('td');
                productNameCell.textContent = item.productName;
                row.appendChild(productNameCell);
                
                // ìˆ˜ëŸ‰
                const quantityCell = document.createElement('td');
                quantityCell.textContent = item.quantity;
                row.appendChild(quantityCell);
                
                // ë°”ì½”ë“œ
                const barcodeCell = document.createElement('td');
                barcodeCell.textContent = item.barcode;
                row.appendChild(barcodeCell);
                
                // ì¶œê³ ì˜ˆì • (ìˆ˜ì • ê°€ëŠ¥)
                const availableOrdersCell = document.createElement('td');
                availableOrdersCell.contentEditable = true;
                availableOrdersCell.textContent = item.availableOrders || '';
                availableOrdersCell.addEventListener('blur', async function() {
                    const newValue = this.textContent.trim();
                    if (newValue !== item.availableOrders) {
                        try {
                            const response = await fetch('/api/importChina/updateAvailableOrders', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    shipmentCode: item.shipmentCode,
                                    barcode: item.barcode,
                                    availableOrders: newValue
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                            }
                            
                            item.availableOrders = newValue;
                        } catch (error) {
                            console.error('Error updating available orders:', error);
                            this.textContent = item.availableOrders || '';
                            alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    }
                });
                row.appendChild(availableOrdersCell);
                
                // ì¶œê³ ì˜ˆì •ì¼
                const shippingDateCell = document.createElement('td');
                shippingDateCell.textContent = item.shippingDate || '';
                row.appendChild(shippingDateCell);
                
                tbody.appendChild(row);
            });
        }

        // ì •ë ¬ í•¨ìˆ˜ ì¶”ê°€
        function sortData(field) {
            if (field === 'none') {
                displayData(globalData);
                return;
            }

            const sortedData = [...globalData].sort((a, b) => {
                // 'ì¶œê³ ì˜ˆì •' ê¸°ì¤€ ì„ íƒ ì‹œ ì´ì¤‘ ì •ë ¬ ì ìš© (ì¶œê³ ì˜ˆì •ì¼ > ì¶œê³ ì˜ˆì •)
                if (field === 'availableOrders') {
                    // 1. ì¶œê³ ì˜ˆì •ì¼ ê¸°ì¤€ ì •ë ¬
                    const dateA = (a.shippingDate || '').toString();
                    const dateB = (b.shippingDate || '').toString();
                    
                    if (dateA !== dateB) {
                        return dateA.localeCompare(dateB);
                    }
                    
                    // 2. ì¶œê³ ì˜ˆì • ê¸°ì¤€ ì •ë ¬
                    const valueA = (a.availableOrders || '').toString().toLowerCase();
                    const valueB = (b.availableOrders || '').toString().toLowerCase();
                    
                    // ì¶œê³ ì˜ˆì • ê°’ì´ ê°™ì€ ê²½ìš° ë°•ìŠ¤ëª…ìœ¼ë¡œ ì •ë ¬
                    if (valueA === valueB) {
                        const boxA = (a.boxName || '').toString().toLowerCase();
                        const boxB = (b.boxName || '').toString().toLowerCase();
                        return boxA.localeCompare(boxB);
                    }
                    
                    return valueA.localeCompare(valueB);
                } else {
                    // ë‹¤ë¥¸ í•„ë“œëŠ” ë‹¨ì¼ ê¸°ì¤€ ì •ë ¬
                    const valueA = (a[field] || '').toString().toLowerCase();
                    const valueB = (b[field] || '').toString().toLowerCase();
                    return valueA.localeCompare(valueB);
                }
            });
            
            displayData(sortedData);
        }

        // ì •ë ¬ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', () => {
            loadImportData();
            
            // ì •ë ¬ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ì„¤ì •
            const sortDropdown = document.getElementById('sortDropdown');
            sortDropdown.addEventListener('change', (e) => {
                sortData(e.target.value);
            });
        });

        // ì‚­ì œ ëª¨ë‹¬ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸
        const deleteButton = document.getElementById('deleteButton');
        const deleteModal = document.getElementById('deleteModal');
        const closeButton = deleteModal.querySelector('.close');
        const shipmentCodeList = document.getElementById('shipmentCodeList');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        let selectedShipmentCode = null;
        
        // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
        deleteButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/importChina/data');
                const data = await response.json();
                
                // ì¶œê³ ì½”ë“œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const shipmentCodes = [...new Set(data.map(item => item.shipmentCode))];
                
                // ì¶œê³ ì½”ë“œ ë²„íŠ¼ ìƒì„±
                shipmentCodeList.innerHTML = '';
                shipmentCodes.forEach(code => {
                    const button = document.createElement('button');
                    button.className = 'shipment-code-button';
                    button.textContent = code;
                    button.addEventListener('click', () => {
                        // ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
                        document.querySelectorAll('.shipment-code-button').forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        button.classList.add('selected');
                        selectedShipmentCode = code;
                    });
                    shipmentCodeList.appendChild(button);
                });
                
                deleteModal.style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
            }
        });
        
        // ëª¨ë‹¬ ë‹«ê¸°
        closeButton.addEventListener('click', () => {
            deleteModal.style.display = 'none';
            selectedShipmentCode = null;
        });
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', (event) => {
            if (event.target === deleteModal) {
                deleteModal.style.display = 'none';
                selectedShipmentCode = null;
            }
        });
        
        // ì‚­ì œ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ
        confirmDeleteButton.addEventListener('click', async () => {
            if (!selectedShipmentCode) {
                alert('ì‚­ì œí•  ì¶œê³ ì½”ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch(`/api/importChina/delete/${selectedShipmentCode}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    deleteModal.style.display = 'none';
                    selectedShipmentCode = null;
                    // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                    loadImportData();
                } else {
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì¸ì‡„ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('printButton').addEventListener('click', () => {
            window.print();
        });

        // ë°œì£¼ì„œ ì •ë¦¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('organizeButton').addEventListener('click', async () => {
            try {
                // ë°œì£¼ì„œ ì •ë¦¬ API í˜¸ì¶œ
                const response = await fetch('/api/importChina/organize', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('ë°œì£¼ì„œ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
                alert('ë°œì£¼ì„œ ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadImportData(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });

        // ì…ê³ 1, ì…ê³ 2 ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
        function showImport1Modal() {
            document.getElementById('import1Modal').style.display = 'block';
            loadShipmentCodes('import1');
        }

        function showImport2Modal() {
            document.getElementById('import2Modal').style.display = 'block';
            loadShipmentCodes('import2');
        }

        function closeImport1Modal() {
            document.getElementById('import1Modal').style.display = 'none';
        }

        function closeImport2Modal() {
            document.getElementById('import2Modal').style.display = 'none';
        }

        async function loadShipmentCodes(type) {
            try {
                const response = await fetch('/api/importChina/data');
                const data = await response.json();
                
                // ì¶œê³ ì½”ë“œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì¤‘ë³µ ì œê±°)
                const shipmentCodes = [...new Set(data.map(item => item.shipmentCode))];
                
                // ì¶œê³ ì½”ë“œ ë²„íŠ¼ ìƒì„±
                const container = document.getElementById(`${type}ShipmentCodeList`);
                container.innerHTML = '';
                
                shipmentCodes.forEach(code => {
                    const button = document.createElement('button');
                    button.className = 'shipment-code-button';
                    button.textContent = code;
                    button.addEventListener('click', () => {
                        // ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
                        document.querySelectorAll(`#${type}ShipmentCodeList .shipment-code-button`).forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        button.classList.add('selected');
                        handleShipmentCodeSelection(code, type);
                    });
                    container.appendChild(button);
                });
            } catch (error) {
                console.error('Error:', error);
                alert('ì¶œê³ ì½”ë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function handleShipmentCodeSelection(shipmentCode, type) {
            try {
                // í˜„ì¬ í…Œì´ë¸”ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤
                const tableBody = document.getElementById('dataBody');
                const rows = tableBody.getElementsByTagName('tr');
                const updateData = [];

                // ì„ íƒëœ ì¶œê³ ì½”ë“œì— í•´ë‹¹í•˜ëŠ” í–‰ë§Œ ì²˜ë¦¬
                for (let row of rows) {
                    const cells = row.getElementsByTagName('td');
                    const currentShipmentCode = cells[0].textContent;
                    const barcode = cells[6].textContent;
                    const availableOrders = cells[7].textContent;
                    
                    if (currentShipmentCode === shipmentCode && barcode && availableOrders) {
                        // ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ëœ ê° ì¶œê³ ì˜ˆì • ë°ì´í„° ì²˜ë¦¬
                        const orders = availableOrders.split('\n');
                        
                        for (const order of orders) {
                            if (order.trim()) {
                                const [orderNumber, logisticsCenter, quantity] = order.split('-');
                                
                                // "000000000" ë°œì£¼ë²ˆí˜¸ëŠ” ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
                                if (orderNumber === '000000000') continue;
                                
                                // ê° ì£¼ë¬¸ì— ëŒ€í•´ ì—…ë°ì´íŠ¸ ë°ì´í„° ìƒì„±
                                updateData.push({
                                    orderNumber,
                                    barcode,
                                    importValue: quantity // ì¶œê³ ê°œìˆ˜ë§Œ ì…ë ¥
                                });
                            }
                        }
                    }
                }

                if (updateData.length === 0) {
                    alert('ì—…ë°ì´íŠ¸í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì„œë²„ì— ì—…ë°ì´íŠ¸ ìš”ì²­
                const endpoint = type === 'import1' ? '/api/orders/updateImport1' : '/api/orders/updateImport2';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error(`${type === 'import1' ? 'ì…ê³ 1' : 'ì…ê³ 2'} ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
                }

                const result = await response.json();
                alert(`${type === 'import1' ? 'ì…ê³ 1' : 'ì…ê³ 2'} ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // ëª¨ë‹¬ ë‹«ê¸°
                if (type === 'import1') {
                    closeImport1Modal();
                } else {
                    closeImport2Modal();
                }
                
                // í˜„ì¬ í˜ì´ì§€ì˜ í…Œì´ë¸”ì„ ìƒˆë¡œê³ ì¹¨
                loadImportData();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        // ì…ê³ 1, ì…ê³ 2 ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('import1Button').addEventListener('click', showImport1Modal);
        document.getElementById('import2Button').addEventListener('click', showImport2Modal);

        // ì…ê³ 1/2 ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('orderOrganizeButton').addEventListener('click', async () => {
            if (!confirm('ì…ê³ 1ê³¼ ì…ê³ 2ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch('/api/orders/resetImport12', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

                alert('ì…ê³ 1ê³¼ ì…ê³ 2ì˜ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadImportData();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });
    </script>
</body>
</html> 