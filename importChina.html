<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïø†Ìå° Î°úÏºì Ï§ëÍµ≠ÏûÖÍ≥†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .top-menu {
            background-color: #fff;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .menu-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }
        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 3px;
            color: #333;
            text-decoration: none;
        }
        .menu-item:hover {
            background-color: #f0f0f0;
        }
        .menu-item.active {
            background-color: #e0e0e0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .upload-area.dragover {
            background-color: #f8f9fa;
            border-color: #4CAF50;
        }
        .upload-area p {
            margin: 15px 0 0;
            color: #666;
        }
        .upload-btn {
            padding: 10px 20px;
            background-color: #FF69B4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .upload-btn:hover {
            background-color: #FF1493;
        }
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .table th, .table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .table tr:hover {
            background-color: #f5f5f5;
        }
        .group-header, .subgroup-header, .item-row, .collapsed, .toggle-icon {
            display: none;
        }
        .button-container {
            margin-top: 20px;
            text-align: right;
        }
        .action-btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .action-btn:hover {
            background-color: #45a049;
        }
        .container h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .container h1 .flag {
            font-size: 1.2em;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            width: 400px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        .close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .close:hover {
            color: #000;
        }
        .modal-body {
            margin-bottom: 20px;
            text-align: center;
        }
        .modal-body input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .modal-footer {
            text-align: center;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 8px 16px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal-btn.confirm {
            background-color: #FF69B4;
            color: white;
        }
        .modal-btn.cancel {
            background-color: #ddd;
            color: #333;
        }
        .table th:nth-child(2),
        .table td:nth-child(2) {
            display: none;
        }
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .left-buttons {
            display: flex;
            gap: 10px;
        }
        
        .right-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .action-button:hover {
            opacity: 0.9;
        }
        
        .organize-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .order-organize-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .import1-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .import2-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .pdf-button {
            background-color: #2196F3;
            color: white;
        }
        
        .delete-button {
            background-color: #f44336;
            color: white;
        }
        
        .shipment-code-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .shipment-code-button:hover {
            background-color: #e9ecef;
        }
        
        .shipment-code-button.selected {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin: 0 auto;
            width: 90%;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .content, .content * {
                visibility: visible;
            }
            .content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .table {
                width: 100%;
                border-collapse: collapse;
                page-break-inside: auto;
                font-size: 9px !important;
            }
            .table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            .table th, .table td {
                border: 1px solid #000;
                padding: 4px;
                font-size: 9px !important;
                line-height: 1.2;
                white-space: nowrap;
            }
            .table th {
                background-color: #f2f2f2 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-weight: bold;
            }
            .table td:nth-child(5), /* ÏÉÅÌíàÎ™Ö */
            .table td:nth-child(8) { /* Ï∂úÍ≥†ÏòàÏ†ï */
                white-space: normal;
                max-width: 200px;
                word-break: break-word;
            }
            .button-group, .upload-container {
                display: none;
            }
            @page {
                size: A4 landscape;
                margin: 0.5cm;
            }
        }
        .table td:nth-child(8) { /* Ï∂úÍ≥†ÏòàÏ†ï Ïó¥ */
            white-space: pre-line;
            max-width: 300px;
            cursor: pointer;
        }
        .editable-cell {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 8px;
            min-height: 100px;
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
            font-size: inherit;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    <div class="container">
        <h1>Ï§ëÍµ≠ÏûÖÍ≥† Í¥ÄÎ¶¨ <span class="flag">üêâ</span></h1>
        <div class="content">
            <div class="button-group">
                <div class="left-buttons">
                    <button class="action-button delete-button" id="deleteButton">ÏÇ≠Ï†ú</button>
                </div>
                <div class="right-buttons">
                    <button class="action-button organize-button" id="organizeButton">CN ÏûÖÍ≥† Ï†ïÎ¶¨</button>
                    <button class="action-button import1-button" id="import1Button">ÏûÖÍ≥†1</button>
                    <button class="action-button import2-button" id="import2Button">ÏûÖÍ≥†2</button>
                    <button class="action-button order-organize-button" id="orderOrganizeButton">ÏûÖÍ≥†1/2 Ï¥àÍ∏∞Ìôî</button>
                    <button class="action-button pdf-button" id="printButton">Ïù∏ÏáÑ</button>
                </div>
            </div>
            
            <div class="upload-container">
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Excel ÌååÏùº ÏóÖÎ°úÎìú üê≤</button>
                    <p>ÎòêÎäî ÌååÏùºÏùÑ Ïó¨Í∏∞Ïóê ÎÅåÏñ¥Îã§ ÎÜìÏúºÏÑ∏Ïöî</p>
                </div>
            </div>

            <!-- Ï†ïÎ†¨ ÎìúÎ°≠Î∞ïÏä§ Ï∂îÍ∞Ä -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                <div style="display: flex; align-items: center;">
                    <label for="sortDropdown" style="margin-right: 10px; font-weight: bold;">Ï†ïÎ†¨ Í∏∞Ï§Ä:</label>
                    <select id="sortDropdown" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; background-color: #f9f9f9;">
                        <option value="none">- ÏÑ†ÌÉù -</option>
                        <option value="boxName">Î∞ïÏä§Î≤àÌò∏</option>
                        <option value="orderNumber">Ï§ëÍµ≠Î≤àÌò∏</option>
                        <option value="productName">ÏÉÅÌíàÎ™Ö</option>
                        <option value="availableOrders">Ï∂úÍ≥†ÏòàÏ†ï</option>
                        <option value="shippingDate">Ï∂úÍ≥†ÏòàÏ†ïÏùº</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ï∂úÍ≥†ÏΩîÎìú</th>
                            <th style="display: none;">ÌåîÎ†õ</th>
                            <th>Î∞ïÏä§Î™Ö</th>
                            <th>Ï§ëÍµ≠Î≤àÌò∏</th>
                            <th>ÏÉÅÌíàÎ™Ö</th>
                            <th>ÏàòÎüâ</th>
                            <th>Î∞îÏΩîÎìú</th>
                            <th>Ï∂úÍ≥†ÏòàÏ†ï</th>
                            <th>Ï∂úÍ≥†ÏòàÏ†ïÏùº</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                        <!-- Îç∞Ïù¥ÌÑ∞Í∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ï∂úÍ≥†ÎÇ†Ïßú ÏûÖÎ†• Î™®Îã¨ -->
    <div id="dateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ï∂úÍ≥†ÏΩîÎìú ÏûÖÎ†•</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <label for="shipmentCode">Ï∂úÍ≥†ÏΩîÎìú:</label>
                <input type="text" id="shipmentCode" placeholder="Ï∂úÍ≥†ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                <button class="modal-btn confirm" onclick="confirmShipmentCode()">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <!-- ÏÇ≠Ï†ú Î™®Îã¨ -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>ÏÇ≠Ï†úÌï† Ï∂úÍ≥†ÏΩîÎìú ÏÑ†ÌÉù</h2>
            <div id="shipmentCodeList">
                <!-- Ï∂úÍ≥†ÏΩîÎìú Î≤ÑÌäºÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
            <div class="button-container">
                <button class="action-button delete-button" id="confirmDeleteButton">ÏÇ≠Ï†ú</button>
            </div>
        </div>
    </div>

    <!-- ÏûÖÍ≥†1 Î™®Îã¨ -->
    <div id="import1Modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ÏûÖÍ≥†1 Ï†ïÎ¶¨</h2>
                <span class="close" onclick="closeImport1Modal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Ï∂úÍ≥†ÏΩîÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                <div class="modal-grid" id="import1ShipmentCodeList">
                    <!-- Ï∂úÍ≥†ÏΩîÎìú Î≤ÑÌäºÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ÏûÖÍ≥†2 Î™®Îã¨ -->
    <div id="import2Modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ÏûÖÍ≥†2 Ï†ïÎ¶¨</h2>
                <span class="close" onclick="closeImport2Modal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Ï∂úÍ≥†ÏΩîÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                <div class="modal-grid" id="import2ShipmentCodeList">
                    <!-- Ï∂úÍ≥†ÏΩîÎìú Î≤ÑÌäºÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;

        // Ìó§Îçî Î°úÎìú
        fetch('/header')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
            });

        // Î™®Îã¨ Í¥ÄÎ†® Ìï®Ïàò
        function showModal() {
            document.getElementById('dateModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('dateModal').style.display = 'none';
            selectedFile = null;
            document.getElementById('shipmentCode').value = '';
        }

        function confirmShipmentCode() {
            const shipmentCode = document.getElementById('shipmentCode').value.trim();
            if (!shipmentCode) {
                alert('Ï∂úÍ≥†ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            if (selectedFile) {
                handleFileUpload(selectedFile, shipmentCode);
            }
            closeModal();
        }

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedFile = files[0];
                showModal();
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                showModal();
            }
        });

        async function handleFileUpload(file, shipmentCode) {
            if (!file.name.endsWith('.xlsx')) {
                alert('Excel ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('shipmentCode', shipmentCode);

            try {
                const response = await fetch('/api/importChina/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('ÌååÏùº ÏóÖÎ°úÎìú Ïã§Ìå®');
                }

                const data = await response.json();
                alert(data.message);
                loadImportData();
            } catch (error) {
                console.error('Error:', error);
                alert('ÌååÏùº ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        let globalData = [];

        // Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò
        async function loadImportData() {
            try {
                const response = await fetch('/api/importChina');
                if (!response.ok) {
                    throw new Error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
                }
                const data = await response.json();
                console.log('Î°úÎìúÎêú Îç∞Ïù¥ÌÑ∞:', data);
                globalData = data; // Ï†ÑÏó≠ Î≥ÄÏàòÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                displayData(data);
            } catch (error) {
                console.error('Error loading data:', error);
                console.error('Error:', error);
            }
        }

        function displayData(data) {
            const tbody = document.getElementById('dataBody');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                
                // Ï∂úÍ≥†ÏΩîÎìú
                const shipmentCodeCell = document.createElement('td');
                shipmentCodeCell.textContent = item.shipmentCode;
                row.appendChild(shipmentCodeCell);
                
                // ÌåîÎ†õ
                const palletCell = document.createElement('td');
                palletCell.textContent = item.pallet;
                row.appendChild(palletCell);
                
                // Î∞ïÏä§Î™Ö
                const boxNameCell = document.createElement('td');
                boxNameCell.textContent = item.boxName;
                row.appendChild(boxNameCell);
                
                // Î∞úÏ£ºÎ≤àÌò∏ (Ï§ëÍµ≠Î≤àÌò∏)
                const orderNumberCell = document.createElement('td');
                orderNumberCell.textContent = item.orderNumber;
                row.appendChild(orderNumberCell);
                
                // ÏÉÅÌíàÎ™Ö
                const productNameCell = document.createElement('td');
                productNameCell.textContent = item.productName;
                row.appendChild(productNameCell);
                
                // ÏàòÎüâ
                const quantityCell = document.createElement('td');
                quantityCell.textContent = item.quantity;
                row.appendChild(quantityCell);
                
                // Î∞îÏΩîÎìú
                const barcodeCell = document.createElement('td');
                barcodeCell.textContent = item.barcode;
                row.appendChild(barcodeCell);
                
                // Ï∂úÍ≥†ÏòàÏ†ï (ÏàòÏ†ï Í∞ÄÎä•)
                const availableOrdersCell = document.createElement('td');
                availableOrdersCell.contentEditable = true;
                availableOrdersCell.textContent = item.availableOrders || '';
                availableOrdersCell.addEventListener('blur', async function() {
                    const newValue = this.textContent.trim();
                    if (newValue !== item.availableOrders) {
                        try {
                            const response = await fetch('/api/importChina/updateAvailableOrders', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    shipmentCode: item.shipmentCode,
                                    barcode: item.barcode,
                                    availableOrders: newValue
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error('ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');
                            }
                            
                            item.availableOrders = newValue;
                        } catch (error) {
                            console.error('Error updating available orders:', error);
                            this.textContent = item.availableOrders || '';
                            alert('ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                        }
                    }
                });
                row.appendChild(availableOrdersCell);
                
                // Ï∂úÍ≥†ÏòàÏ†ïÏùº
                const shippingDateCell = document.createElement('td');
                shippingDateCell.textContent = item.shippingDate || '';
                row.appendChild(shippingDateCell);
                
                tbody.appendChild(row);
            });
        }

        // Ï†ïÎ†¨ Ìï®Ïàò Ï∂îÍ∞Ä
        function sortData(field) {
            if (field === 'none') {
                displayData(globalData);
                return;
            }

            const sortedData = [...globalData].sort((a, b) => {
                // 'Ï∂úÍ≥†ÏòàÏ†ï' Í∏∞Ï§Ä ÏÑ†ÌÉù Ïãú Ïù¥Ï§ë Ï†ïÎ†¨ Ï†ÅÏö© (Ï∂úÍ≥†ÏòàÏ†ïÏùº > Ï∂úÍ≥†ÏòàÏ†ï)
                if (field === 'availableOrders') {
                    // 1. Ï∂úÍ≥†ÏòàÏ†ïÏùº Í∏∞Ï§Ä Ï†ïÎ†¨
                    const dateA = (a.shippingDate || '').toString();
                    const dateB = (b.shippingDate || '').toString();
                    
                    if (dateA !== dateB) {
                        return dateA.localeCompare(dateB);
                    }
                    
                    // 2. Ï∂úÍ≥†ÏòàÏ†ï Í∏∞Ï§Ä Ï†ïÎ†¨
                    const valueA = (a.availableOrders || '').toString().toLowerCase();
                    const valueB = (b.availableOrders || '').toString().toLowerCase();
                    
                    // Ï∂úÍ≥†ÏòàÏ†ï Í∞íÏù¥ Í∞ôÏùÄ Í≤ΩÏö∞ Î∞ïÏä§Î™ÖÏúºÎ°ú Ï†ïÎ†¨
                    if (valueA === valueB) {
                        const boxA = (a.boxName || '').toString().toLowerCase();
                        const boxB = (b.boxName || '').toString().toLowerCase();
                        return boxA.localeCompare(boxB);
                    }
                    
                    return valueA.localeCompare(valueB);
                } else {
                    // Îã§Î•∏ ÌïÑÎìúÎäî Îã®Ïùº Í∏∞Ï§Ä Ï†ïÎ†¨
                    const valueA = (a[field] || '').toString().toLowerCase();
                    const valueB = (b[field] || '').toString().toLowerCase();
                    return valueA.localeCompare(valueB);
                }
            });
            
            displayData(sortedData);
        }

        // Ï†ïÎ†¨ ÎìúÎ°≠Îã§Ïö¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        document.addEventListener('DOMContentLoaded', () => {
            loadImportData();
            
            // Ï†ïÎ†¨ ÎìúÎ°≠Îã§Ïö¥ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
            const sortDropdown = document.getElementById('sortDropdown');
            sortDropdown.addEventListener('change', (e) => {
                sortData(e.target.value);
            });
        });

        // ÏÇ≠Ï†ú Î™®Îã¨ Í¥ÄÎ†® Ïä§ÌÅ¨Î¶ΩÌä∏
        const deleteButton = document.getElementById('deleteButton');
        const deleteModal = document.getElementById('deleteModal');
        const closeButton = deleteModal.querySelector('.close');
        const shipmentCodeList = document.getElementById('shipmentCodeList');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        let selectedShipmentCode = null;
        
        // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Î™®Îã¨ Ïó¥Í∏∞
        deleteButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/importChina/data');
                const data = await response.json();
                
                // Ï∂úÍ≥†ÏΩîÎìú Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
                const shipmentCodes = [...new Set(data.map(item => item.shipmentCode))];
                
                // Ï∂úÍ≥†ÏΩîÎìú Î≤ÑÌäº ÏÉùÏÑ±
                shipmentCodeList.innerHTML = '';
                shipmentCodes.forEach(code => {
                    const button = document.createElement('button');
                    button.className = 'shipment-code-button';
                    button.textContent = code;
                    button.addEventListener('click', () => {
                        // ÏÑ†ÌÉùÎêú Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
                        document.querySelectorAll('.shipment-code-button').forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        button.classList.add('selected');
                        selectedShipmentCode = code;
                    });
                    shipmentCodeList.appendChild(button);
                });
                
                deleteModal.style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
            }
        });
        
        // Î™®Îã¨ Îã´Í∏∞
        closeButton.addEventListener('click', () => {
            deleteModal.style.display = 'none';
            selectedShipmentCode = null;
        });
        
        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        window.addEventListener('click', (event) => {
            if (event.target === deleteModal) {
                deleteModal.style.display = 'none';
                selectedShipmentCode = null;
            }
        });
        
        // ÏÇ≠Ï†ú ÌôïÏù∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
        confirmDeleteButton.addEventListener('click', async () => {
            if (!selectedShipmentCode) {
                alert('ÏÇ≠Ï†úÌï† Ï∂úÍ≥†ÏΩîÎìúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const response = await fetch(`/api/importChina/delete/${selectedShipmentCode}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('ÏÇ≠Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
                    deleteModal.style.display = 'none';
                    selectedShipmentCode = null;
                    // ÌÖåÏù¥Î∏î ÏÉàÎ°úÍ≥†Ïπ®
                    loadImportData();
                } else {
                    alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        });

        // Ïù∏ÏáÑ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.getElementById('printButton').addEventListener('click', () => {
            window.print();
        });

        // Î∞úÏ£ºÏÑú Ï†ïÎ¶¨ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.getElementById('organizeButton').addEventListener('click', async () => {
            try {
                // Î∞úÏ£ºÏÑú Ï†ïÎ¶¨ API Ìò∏Ï∂ú
                const response = await fetch('/api/importChina/organize', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Î∞úÏ£ºÏÑú Ï†ïÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
                
                alert('Î∞úÏ£ºÏÑú Ï†ïÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
                loadImportData(); // ÌÖåÏù¥Î∏î ÏÉàÎ°úÍ≥†Ïπ®
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });

        // ÏûÖÍ≥†1, ÏûÖÍ≥†2 Î™®Îã¨ Í¥ÄÎ†® Ìï®Ïàò
        function showImport1Modal() {
            document.getElementById('import1Modal').style.display = 'block';
            loadShipmentCodes('import1');
        }

        function showImport2Modal() {
            document.getElementById('import2Modal').style.display = 'block';
            loadShipmentCodes('import2');
        }

        function closeImport1Modal() {
            document.getElementById('import1Modal').style.display = 'none';
        }

        function closeImport2Modal() {
            document.getElementById('import2Modal').style.display = 'none';
        }

        async function loadShipmentCodes(type) {
            try {
                const response = await fetch('/api/importChina/data');
                const data = await response.json();
                
                // Ï∂úÍ≥†ÏΩîÎìú Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ (Ï§ëÎ≥µ Ï†úÍ±∞)
                const shipmentCodes = [...new Set(data.map(item => item.shipmentCode))];
                
                // Ï∂úÍ≥†ÏΩîÎìú Î≤ÑÌäº ÏÉùÏÑ±
                const container = document.getElementById(`${type}ShipmentCodeList`);
                container.innerHTML = '';
                
                shipmentCodes.forEach(code => {
                    const button = document.createElement('button');
                    button.className = 'shipment-code-button';
                    button.textContent = code;
                    button.addEventListener('click', () => {
                        // ÏÑ†ÌÉùÎêú Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
                        document.querySelectorAll(`#${type}ShipmentCodeList .shipment-code-button`).forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        button.classList.add('selected');
                        handleShipmentCodeSelection(code, type);
                    });
                    container.appendChild(button);
                });
            } catch (error) {
                console.error('Error:', error);
                alert('Ï∂úÍ≥†ÏΩîÎìú Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        async function handleShipmentCodeSelection(shipmentCode, type) {
            try {
                // ÌòÑÏû¨ ÌÖåÏù¥Î∏îÏùò Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏ÏòµÎãàÎã§
                const tableBody = document.getElementById('dataBody');
                const rows = tableBody.getElementsByTagName('tr');
                const updateData = [];

                // ÏÑ†ÌÉùÎêú Ï∂úÍ≥†ÏΩîÎìúÏóê Ìï¥ÎãπÌïòÎäî ÌñâÎßå Ï≤òÎ¶¨
                for (let row of rows) {
                    const cells = row.getElementsByTagName('td');
                    const currentShipmentCode = cells[0].textContent;
                    const barcode = cells[6].textContent;
                    const availableOrders = cells[7].textContent;
                    
                    if (currentShipmentCode === shipmentCode && barcode && availableOrders) {
                        // Ï§ÑÎ∞îÍøàÏúºÎ°ú Íµ¨Î∂ÑÎêú Í∞Å Ï∂úÍ≥†ÏòàÏ†ï Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                        const orders = availableOrders.split('\n');
                        
                        for (const order of orders) {
                            if (order.trim()) {
                                const [orderNumber, logisticsCenter, quantity] = order.split('-');
                                
                                // "000000000" Î∞úÏ£ºÎ≤àÌò∏Îäî Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùå
                                if (orderNumber === '000000000') continue;
                                
                                // Í∞Å Ï£ºÎ¨∏Ïóê ÎåÄÌï¥ ÏóÖÎç∞Ïù¥Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                                updateData.push({
                                    orderNumber,
                                    barcode,
                                    importValue: quantity // Ï∂úÍ≥†Í∞úÏàòÎßå ÏûÖÎ†•
                                });
                            }
                        }
                    }
                }

                if (updateData.length === 0) {
                    alert('ÏóÖÎç∞Ïù¥Ìä∏Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                // ÏÑúÎ≤ÑÏóê ÏóÖÎç∞Ïù¥Ìä∏ ÏöîÏ≤≠
                const endpoint = type === 'import1' ? '/api/orders/updateImport1' : '/api/orders/updateImport2';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error(`${type === 'import1' ? 'ÏûÖÍ≥†1' : 'ÏûÖÍ≥†2'} Ï†ïÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.`);
                }

                const result = await response.json();
                alert(`${type === 'import1' ? 'ÏûÖÍ≥†1' : 'ÏûÖÍ≥†2'} Ï†ïÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.`);
                
                // Î™®Îã¨ Îã´Í∏∞
                if (type === 'import1') {
                    closeImport1Modal();
                } else {
                    closeImport2Modal();
                }
                
                // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏùò ÌÖåÏù¥Î∏îÏùÑ ÏÉàÎ°úÍ≥†Ïπ®
                loadImportData();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        // ÏûÖÍ≥†1, ÏûÖÍ≥†2 Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.getElementById('import1Button').addEventListener('click', showImport1Modal);
        document.getElementById('import2Button').addEventListener('click', showImport2Modal);

        // ÏûÖÍ≥†1/2 Ï¥àÍ∏∞Ìôî Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        document.getElementById('orderOrganizeButton').addEventListener('click', async () => {
            if (!confirm('ÏûÖÍ≥†1Í≥º ÏûÖÍ≥†2Ïùò Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                const response = await fetch('/api/orders/resetImport12', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }

                alert('ÏûÖÍ≥†1Í≥º ÏûÖÍ≥†2Ïùò Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
                loadImportData();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });
    </script>
</body>
</html> 