<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>쿠팡 물류센터 관리</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .wh-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .wh-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .wh-upload-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            gap: 10px;
        }
        .wh-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }
        .wh-btn-upload {
            background-color: #4CAF50;
        }
        .wh-btn-upload:hover {
            background-color: #45a049;
        }
        .wh-btn-edit {
            background-color: #2196F3;
        }
        .wh-btn-edit:hover {
            background-color: #0b7dda;
        }
        .wh-btn-delete {
            background-color: #f44336;
        }
        .wh-btn-delete:hover {
            background-color: #d32f2f;
        }
        .wh-table-container {
            overflow-x: auto;
        }
        .wh-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .wh-table th, .wh-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .wh-table th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        .wh-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        .wh-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* 모달 스타일 */
        .wh-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .wh-overlay.active {
            display: block;
        }
        .wh-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 500px;
            max-width: 90%;
        }
        .wh-modal.active {
            display: block;
        }
        .wh-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        .wh-modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }
        .wh-modal-buttons {
            display: flex;
            gap: 10px;
        }
        .wh-modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .wh-btn-close {
            background-color: #f1f1f1;
            color: #333;
        }
        .wh-btn-close:hover {
            background-color: #e0e0e0;
        }
        .wh-btn-save {
            background-color: #4CAF50;
            color: white;
        }
        .wh-btn-save:hover {
            background-color: #45a049;
        }
        .wh-form-group {
            margin-bottom: 20px;
        }
        .wh-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        .wh-form-group label .required {
            color: #f44336;
        }
        .wh-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .wh-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .wh-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
        }
        .wh-textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        /* 로딩 인디케이터 */
        .wh-loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .wh-loading.active {
            display: flex;
        }
        .wh-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        .wh-loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="wh-header-container"></div>
    <div class="wh-container">
        <h1>쿠팡 물류센터 관리</h1>
        <div class="wh-content">
            <div class="wh-upload-section">
                <button class="wh-btn wh-btn-upload" onclick="whUploadExcel()">엑셀추가</button>
                <button class="wh-btn wh-btn-upload" onclick="whOpenModal('add')">직접추가</button>
                <button class="wh-btn wh-btn-edit" onclick="whOpenModal('edit')">수정</button>
                <button class="wh-btn wh-btn-delete" onclick="whDeleteCenters()">삭제</button>
                <input type="file" id="whFileInput" style="display: none" accept=".xlsx,.xls">
            </div>

            <div class="wh-table-container">
                <table class="wh-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" class="wh-checkbox" id="whSelectAll"></th>
                            <th style="width: 135px;">물류센터</th>
                            <th style="width: 180px;">연락처</th>
                            <th style="width: auto;">주소</th>
                            <th style="width: 150px;">비고</th>
                        </tr>
                    </thead>
                    <tbody id="whTableBody">
                        <!-- 데이터 동적 로드 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 직접추가/수정 모달 -->
    <div class="wh-overlay" id="whModalOverlay"></div>
    <div class="wh-modal" id="whCenterModal">
        <div class="wh-modal-header">
            <h3 id="whModalTitle">물류센터 추가</h3>
            <div class="wh-modal-buttons">
                <button class="wh-modal-btn wh-btn-close" onclick="whCloseModal()">닫기</button>
                <button class="wh-modal-btn wh-btn-save" onclick="whSaveCenter()">저장</button>
            </div>
        </div>
        <div>
            <input type="hidden" id="whCenterId">
            <div class="wh-form-group">
                <label>물류센터 <span class="required">*</span></label>
                <input type="text" class="wh-input" id="whCenterName" placeholder="물류센터명을 입력하세요">
            </div>
            <div class="wh-form-group">
                <label>연락처 <span class="required">*</span></label>
                <input type="text" class="wh-input" id="whContact" placeholder="연락처를 입력하세요">
            </div>
            <div class="wh-form-group">
                <label>주소 <span class="required">*</span></label>
                <input type="text" class="wh-input" id="whAddress" placeholder="주소를 입력하세요">
            </div>
            <div class="wh-form-group">
                <label>비고</label>
                <textarea class="wh-textarea" id="whNote" placeholder="비고를 입력하세요 (선택사항)"></textarea>
            </div>
        </div>
    </div>

    <!-- 로딩 -->
    <div class="wh-loading" id="whLoading">
        <div class="wh-spinner"></div>
        <div class="wh-loading-text">처리 중...</div>
    </div>

    <script>
        let whModalMode = 'add'; // 'add' or 'edit'

        // 페이지 로드 시
        document.addEventListener('DOMContentLoaded', function() {
            // 헤더 로드
            fetch('/header')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('wh-header-container').innerHTML = html;
                });

            // 데이터 로드
            whLoadCenters();

            // 전체 선택 체크박스
            document.getElementById('whSelectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.wh-item-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });

            // 오버레이 클릭 시 모달 닫기
            document.getElementById('whModalOverlay').addEventListener('click', whCloseModal);

            // 엑셀 파일 입력
            document.getElementById('whFileInput').addEventListener('change', whHandleExcelFile);
        });

        // 데이터 로드
        async function whLoadCenters() {
            try {
                const response = await fetch('/api/warehouse/centers');
                if (!response.ok) throw new Error('데이터 로드 실패');

                const centers = await response.json();
                whDisplayCenters(centers);
            } catch (error) {
                console.error('Error:', error);
                alert('데이터를 불러오는데 실패했습니다.');
            }
        }

        // 테이블에 데이터 표시
        function whDisplayCenters(centers) {
            const tbody = document.getElementById('whTableBody');
            tbody.innerHTML = '';

            if (centers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">등록된 물류센터가 없습니다.</td></tr>';
                return;
            }

            centers.forEach(center => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="wh-checkbox wh-item-checkbox" data-id="${center.id}"></td>
                    <td>${center.center}</td>
                    <td>${center.contact || '-'}</td>
                    <td>${center.address || '-'}</td>
                    <td>${center.note || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 엑셀 업로드
        function whUploadExcel() {
            document.getElementById('whFileInput').click();
        }

        // 엑셀 파일 처리
        function whHandleExcelFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // 헤더 제거 (첫 행)
                    const rows = jsonData.slice(1);

                    const rawCenters = rows
                        .filter(row => row[0]) // A열(물류센터)이 있는 행만
                        .map(row => ({
                            center: row[0]?.toString().trim() || '',
                            contact: row[1]?.toString().trim() || '',
                            address: row[2]?.toString().trim() || ''
                        }));

                    // 엑셀 내 중복 제거 (물류센터명 기준)
                    const centerMap = new Map();
                    rawCenters.forEach(item => {
                        if (!centerMap.has(item.center)) {
                            centerMap.set(item.center, item);
                        }
                    });

                    const centers = Array.from(centerMap.values());

                    console.log(`엑셀 원본 데이터: ${rawCenters.length}개, 중복 제거 후: ${centers.length}개`);

                    if (centers.length === 0) {
                        alert('유효한 데이터가 없습니다.');
                        e.target.value = '';
                        return;
                    }

                    // 중복이 제거되었다면 사용자에게 알림
                    if (rawCenters.length > centers.length) {
                        const duplicateCount = rawCenters.length - centers.length;
                        console.log(`엑셀 내 중복 ${duplicateCount}개 제거됨`);
                    }

                    whUploadCenters(centers);
                } catch (error) {
                    console.error('Error:', error);
                    alert('엑셀 파일 처리 중 오류가 발생했습니다.');
                    e.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 엑셀 데이터 업로드
        async function whUploadCenters(centers) {
            whShowLoading();
            try {
                console.log('업로드할 데이터:', centers);

                const response = await fetch('/api/warehouse/centers/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ centers })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('서버 응답 오류:', response.status, errorText);
                    throw new Error(`서버 오류 (${response.status})`);
                }

                const result = await response.json();
                whHideLoading();

                console.log('서버 응답:', result);

                if (result.duplicates && result.duplicates.length > 0) {
                    alert(`동일한 물류센터가 존재합니다:\n\n${result.duplicates.join('\n')}\n\n확인을 클릭하면 페이지가 새로고침됩니다.`);
                    location.reload();
                } else if (result.success) {
                    alert(`${result.added}개의 물류센터가 추가되었습니다.`);
                    location.reload();
                } else {
                    throw new Error(result.error || '업로드 실패');
                }
            } catch (error) {
                whHideLoading();
                console.error('업로드 오류 상세:', error);
                alert('업로드 중 오류가 발생했습니다: ' + error.message);
            } finally {
                document.getElementById('whFileInput').value = '';
            }
        }

        // 모달 열기
        function whOpenModal(mode) {
            whModalMode = mode;

            if (mode === 'add') {
                document.getElementById('whModalTitle').textContent = '물류센터 추가';
                document.getElementById('whCenterId').value = '';
                document.getElementById('whCenterName').value = '';
                document.getElementById('whContact').value = '';
                document.getElementById('whAddress').value = '';
                document.getElementById('whNote').value = '';
            } else if (mode === 'edit') {
                const selected = document.querySelectorAll('.wh-item-checkbox:checked');
                if (selected.length === 0) {
                    alert('수정할 물류센터를 선택해주세요.');
                    return;
                }
                if (selected.length > 1) {
                    alert('한 개의 물류센터만 선택해주세요.');
                    return;
                }

                const id = selected[0].getAttribute('data-id');
                const row = selected[0].closest('tr');

                document.getElementById('whModalTitle').textContent = '물류센터 수정';
                document.getElementById('whCenterId').value = id;
                document.getElementById('whCenterName').value = row.cells[1].textContent;
                document.getElementById('whContact').value = row.cells[2].textContent === '-' ? '' : row.cells[2].textContent;
                document.getElementById('whAddress').value = row.cells[3].textContent === '-' ? '' : row.cells[3].textContent;
                document.getElementById('whNote').value = row.cells[4].textContent === '-' ? '' : row.cells[4].textContent;
            }

            document.getElementById('whModalOverlay').classList.add('active');
            document.getElementById('whCenterModal').classList.add('active');
        }

        // 모달 닫기
        function whCloseModal() {
            document.getElementById('whModalOverlay').classList.remove('active');
            document.getElementById('whCenterModal').classList.remove('active');
        }

        // 저장
        async function whSaveCenter() {
            const center = document.getElementById('whCenterName').value.trim();
            const contact = document.getElementById('whContact').value.trim();
            const address = document.getElementById('whAddress').value.trim();
            const note = document.getElementById('whNote').value.trim();

            if (!center || !contact || !address) {
                alert('물류센터, 연락처, 주소는 필수 입력 항목입니다.');
                return;
            }

            whShowLoading();

            try {
                if (whModalMode === 'add') {
                    // 추가
                    const response = await fetch('/api/warehouse/centers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ center, contact, address, note })
                    });

                    const result = await response.json();
                    whHideLoading();

                    if (result.duplicate) {
                        alert(`동일한 물류센터가 존재합니다:\n\n${center}`);
                    } else if (result.success) {
                        alert('물류센터가 추가되었습니다.');
                        whCloseModal();
                        whLoadCenters();
                    } else {
                        throw new Error(result.error || '추가 실패');
                    }
                } else if (whModalMode === 'edit') {
                    // 수정
                    const id = document.getElementById('whCenterId').value;
                    const response = await fetch(`/api/warehouse/centers/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ center, contact, address, note })
                    });

                    const result = await response.json();
                    whHideLoading();

                    if (result.duplicate) {
                        alert(`동일한 물류센터가 존재합니다:\n\n${center}`);
                    } else if (result.success) {
                        alert('물류센터가 수정되었습니다.');
                        whCloseModal();
                        whLoadCenters();
                    } else {
                        throw new Error(result.error || '수정 실패');
                    }
                }
            } catch (error) {
                whHideLoading();
                console.error('Error:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        // 삭제
        async function whDeleteCenters() {
            const selected = document.querySelectorAll('.wh-item-checkbox:checked');
            if (selected.length === 0) {
                alert('삭제할 물류센터를 선택해주세요.');
                return;
            }

            if (!confirm(`선택한 ${selected.length}개의 물류센터를 삭제하시겠습니까?`)) {
                return;
            }

            const ids = Array.from(selected).map(cb => cb.getAttribute('data-id'));

            whShowLoading();
            try {
                const response = await fetch('/api/warehouse/centers', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });

                const result = await response.json();
                whHideLoading();

                if (result.success) {
                    alert(`${result.deleted}개의 물류센터가 삭제되었습니다.`);
                    whLoadCenters();
                    document.getElementById('whSelectAll').checked = false;
                } else {
                    throw new Error(result.error || '삭제 실패');
                }
            } catch (error) {
                whHideLoading();
                console.error('Error:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        // 로딩 표시
        function whShowLoading() {
            document.getElementById('whLoading').classList.add('active');
        }

        // 로딩 숨김
        function whHideLoading() {
            document.getElementById('whLoading').classList.remove('active');
        }
    </script>
</body>
</html>
